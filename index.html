<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagesplan Erinnerungen - 1500 kcal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        body.medical {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            transition: background 0.5s ease;
        }
        
        body.medical .header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .current-time {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .status {
            font-size: 18px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: inline-block;
        }
        
        .content {
            padding: 30px;
        }
        
        .next-item {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }
        
        body.medical .next-item {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }
        
        .next-item h2 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .next-item h2::before {
            content: "‚è∞";
            font-size: 24px;
        }
        
        .next-item .time {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .next-item .description {
            font-size: 16px;
            line-height: 1.6;
        }
        
        .timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline::before {
            content: "";
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
        }
        
        body.medical .timeline::before {
            background: linear-gradient(180deg, #66bb6a 0%, #388e3c 100%);
        }
        
        .timeline-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .timeline-item::before {
            content: "";
            position: absolute;
            left: -33px;
            top: 20px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            transition: border-color 0.5s ease;
        }
        
        body.medical .timeline-item::before {
            border-color: #4caf50;
        }
        
        .timeline-item.completed {
            opacity: 0.5;
            background: #e9ecef;
        }
        
        .timeline-item.completed::before {
            background: #28a745;
            border-color: #28a745;
        }
        
        .timeline-item.current {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.4);
            transition: all 0.3s ease;
        }
        
        body.medical .timeline-item.current {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            box-shadow: 0 5px 15px rgba(165, 214, 167, 0.4);
        }
        
        .timeline-item.current::before {
            background: #fdcb6e;
            border-color: #fdcb6e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        
        .timeline-item .time {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
            margin-bottom: 5px;
            transition: color 0.5s ease;
        }
        
        body.medical .timeline-item .time {
            color: #2e7d32;
        }
        
        .timeline-item.current .time {
            color: #d63031;
        }
        
        body.medical .timeline-item.current .time {
            color: #1b5e20;
        }
        
        .timeline-item .description {
            color: #2d3436;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .timeline-item .calories {
            color: #0984e3;
            font-weight: bold;
            margin-top: 5px;
            font-size: 13px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        body.medical .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        body.medical .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: #2d3436;
        }
        
        .btn-secondary:hover {
            background: #dfe6e9;
        }
        
        .notification-permission {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .notification-permission.show {
            display: block;
        }
        
        .sound-toggle {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .sound-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Dein Tagesplan</h1>
            <div class="current-time" id="currentTime">00:00:00</div>
            <div class="status" id="status">L√§dt...</div>
            <div class="sound-toggle">
                <input type="checkbox" id="soundToggle" checked onchange="toggleSound()">
                <label for="soundToggle" style="cursor: pointer;">üîä Signalton aktiviert</label>
            </div>
        </div>
        
        <div class="content">
            <div class="notification-permission" id="notificationAlert">
                <strong>‚ö†Ô∏è Benachrichtigungen aktivieren?</strong><br>
                Damit du rechtzeitig erinnert wirst, erlaube bitte die Browser-Benachrichtigungen.
                <button class="btn btn-primary" onclick="requestNotificationPermission()" style="margin-top: 10px;">
                    Benachrichtigungen aktivieren
                </button>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="toggleTheme()">üé® Design wechseln</button>
                <button class="btn btn-primary" onclick="testNotification()">üîî Test-Benachrichtigung</button>
                <button class="btn btn-secondary" onclick="scrollToNext()">‚¨áÔ∏è Zum n√§chsten Punkt</button>
            </div>
            
            <div id="nextItem"></div>
            
            <h3 style="margin-bottom: 20px; color: #2d3436;">üìã Tages√ºbersicht</h3>
            <div class="timeline" id="timeline"></div>
        </div>
    </div>

    <script>
        const schedule = [
            { time: "06:15", title: "Prednisolon", description: "", calories: 0 },
            { time: "06:30", title: "Vitamin-B-Komplex", description: "", calories: 0 },
            { time: "06:40", title: "Magnesium-Malat", description: "", calories: 0 },
            { time: "06:45", title: "L-Glutamin", description: "5 g", calories: 0 },
            { time: "07:00", title: "Medikamente", description: "Eliquis/Apixaban 5 mg + Vitamin D3/K2 + Omega-3 + Q10 + Finerenon 10 mg", calories: 0 },
            { time: "07:30", title: "Kollagen-Drink", description: "10 g", calories: 36 },
            { time: "08:00", title: "Fr√ºhst√ºck (leicht)", description: "40 g Hafer, 150 g Magerquark, 1 TL Flohsamen, 1 TL Haferkleie, 1 EL Lein√∂l, 80-100 g Beeren", calories: 340 },
            { time: "09:00", title: "Herz/Niere", description: "Bisoprolol, Amlodipin, Ezetimib", calories: 0 },
            { time: "09:30", title: "Eiwei√üblock (klein)", description: "250 g Magerquark, 1 Ei", calories: 250 },
            { time: "12:30", title: "Mittagessen", description: "300-350 g Gem√ºse, 1 EL Lein√∂l, 2 Eier", calories: 370 },
            { time: "13:00", title: "Artischocke", description: "", calories: 0 },
            { time: "15:30", title: "Haferportion", description: "30 g Hafer, Optional: Flohsamen", calories: 117 },
            { time: "17:30", title: "L-Glutamin zweite Portion", description: "3-5 g", calories: 0 },
            { time: "18:00", title: "Abendmedikamente", description: "Eliquis/Apixaban 5 mg + Artischocke 2 + Rosuvastatin + Ramipril", calories: 0 },
            { time: "18:00", title: "Abendessen", description: "W√§hle eine Option: A) H√ºttenk√§se + Gem√ºse, B) Eier + Salat, C) Magerquark + Gem√ºse, D) H√§hnchen/Fisch + Gem√ºse, E) Gem√ºsesuppe + Quark", calories: 290 },
            { time: "20:30", title: "Zink", description: "nur mit Wasser", calories: 0 },
            { time: "22:00", title: "Magnesium-Bisglycinat", description: "", calories: 0 }
        ];

        let lastNotifiedIndex = -1;
        let soundEnabled = true;
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('AudioContext initialisiert');
            }
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('de-DE');
            document.getElementById('currentTime').textContent = timeString;
        }

        function getTimeInMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function getCurrentMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }

        function findCurrentAndNext() {
            const currentMinutes = getCurrentMinutes();
            let currentIndex = -1;
            let nextIndex = -1;

            for (let i = 0; i < schedule.length; i++) {
                const itemMinutes = getTimeInMinutes(schedule[i].time);
                
                if (itemMinutes <= currentMinutes) {
                    currentIndex = i;
                } else {
                    nextIndex = i;
                    break;
                }
            }

            return { currentIndex, nextIndex };
        }

        function updateTimeline() {
            const timeline = document.getElementById('timeline');
            const { currentIndex, nextIndex } = findCurrentAndNext();
            
            timeline.innerHTML = '';
            
            schedule.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.id = `item-${index}`;
                
                if (index < currentIndex) {
                    div.classList.add('completed');
                } else if (index === currentIndex) {
                    div.classList.add('current');
                }
                
                div.innerHTML = `
                    <div class="time">${item.time} Uhr</div>
                    <div class="description">
                        <strong>${item.title}</strong>
                        ${item.description ? `<br>${item.description}` : ''}
                    </div>
                    ${item.calories > 0 ? `<div class="calories">üìä ${item.calories} kcal</div>` : ''}
                `;
                
                timeline.appendChild(div);
            });
        }

        function updateNextItem() {
            const { currentIndex, nextIndex } = findCurrentAndNext();
            const nextItemDiv = document.getElementById('nextItem');
            const statusDiv = document.getElementById('status');
            
            if (nextIndex === -1) {
                nextItemDiv.innerHTML = `
                    <div class="next-item">
                        <h2>‚úÖ Tagesplan abgeschlossen!</h2>
                        <div class="description">Alle Punkte f√ºr heute erledigt. Gute Nacht! üåô</div>
                    </div>
                `;
                statusDiv.textContent = 'Tagesplan abgeschlossen';
            } else {
                const nextItem = schedule[nextIndex];
                const currentMinutes = getCurrentMinutes();
                const nextMinutes = getTimeInMinutes(nextItem.time);
                const minutesUntil = nextMinutes - currentMinutes;
                
                nextItemDiv.innerHTML = `
                    <div class="next-item">
                        <h2>Als N√§chstes:</h2>
                        <div class="time">${nextItem.time} Uhr</div>
                        <div class="description">
                            <strong>${nextItem.title}</strong><br>
                            ${nextItem.description ? `${nextItem.description}<br>` : ''}
                            ${nextItem.calories > 0 ? `<br>üìä ${nextItem.calories} kcal` : ''}
                        </div>
                    </div>
                `;
                
                if (minutesUntil <= 0) {
                    statusDiv.textContent = '‚è∞ JETZT!';
                } else if (minutesUntil < 60) {
                    statusDiv.textContent = `‚è∞ In ${minutesUntil} Minuten`;
                } else {
                    const hours = Math.floor(minutesUntil / 60);
                    const mins = minutesUntil % 60;
                    statusDiv.textContent = `‚è∞ In ${hours}h ${mins}min`;
                }
            }
        }

        function checkForNotifications() {
            if (Notification.permission !== 'granted') return;
            
            const { currentIndex, nextIndex } = findCurrentAndNext();
            
            if (nextIndex !== -1 && nextIndex !== lastNotifiedIndex) {
                const nextItem = schedule[nextIndex];
                const currentMinutes = getCurrentMinutes();
                const nextMinutes = getTimeInMinutes(nextItem.time);
                const minutesUntil = nextMinutes - currentMinutes;
                
                // Benachrichtigung wenn Zeit erreicht ist (innerhalb von 10 Minuten Toleranz)
                if (minutesUntil <= 0 && minutesUntil > -10) {
                    console.log('Sende Benachrichtigung f√ºr:', nextItem.title, 'um', nextItem.time);
                    sendNotification(nextItem);
                    lastNotifiedIndex = nextIndex;
                }
            }
        }

        function playSound() {
            try {
                // Erzeuge einen angenehmen Benachrichtigungston
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Wichtig: AudioContext muss m√∂glicherweise erst resumed werden
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Erster Ton (h√∂her)
                const oscillator1 = audioContext.createOscillator();
                const gainNode1 = audioContext.createGain();
                oscillator1.connect(gainNode1);
                gainNode1.connect(audioContext.destination);
                oscillator1.frequency.value = 800;
                oscillator1.type = 'sine';
                gainNode1.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.3);
                
                // Zweiter Ton (tiefer) nach kurzer Pause
                setTimeout(() => {
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode2 = audioContext.createGain();
                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext.destination);
                    oscillator2.frequency.value = 600;
                    oscillator2.type = 'sine';
                    gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator2.start(audioContext.currentTime);
                    oscillator2.stop(audioContext.currentTime + 0.4);
                }, 200);
                
                console.log('Sound erfolgreich abgespielt, AudioContext State:', audioContext.state);
            } catch (error) {
                console.error('Fehler beim Abspielen des Sounds:', error);
            }
        }

        function sendNotification(item) {
            console.log('sendNotification aufgerufen f√ºr:', item.title, 'Sound:', soundEnabled);
            
            // Spiele Signalton ab, wenn aktiviert
            if (soundEnabled) {
                console.log('Spiele Sound ab...');
                playSound();
            }
            
            const notification = new Notification('üçΩÔ∏è Tagesplan Erinnerung', {
                body: `${item.time} Uhr: ${item.title}${item.description ? '\n' + item.description : ''}`,
                icon: 'üîî',
                tag: 'meal-reminder',
                requireInteraction: true
            });
            
            notification.onclick = function() {
                window.focus();
                notification.close();
            };
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    document.getElementById('notificationAlert').classList.remove('show');
                    alert('‚úÖ Benachrichtigungen aktiviert!');
                }
            });
        }

        function testNotification() {
            if (Notification.permission === 'granted') {
                if (soundEnabled) {
                    playSound();
                }
                new Notification('üçΩÔ∏è Test-Benachrichtigung', {
                    body: 'Die Benachrichtigungen funktionieren! Du wirst zur richtigen Zeit erinnert.',
                    icon: 'üîî'
                });
            } else if (Notification.permission === 'denied') {
                alert('Benachrichtigungen wurden blockiert. Bitte aktiviere sie in den Browser-Einstellungen.');
            } else {
                requestNotificationPermission();
            }
        }

        function toggleSound() {
            soundEnabled = document.getElementById('soundToggle').checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            
            const label = document.querySelector('label[for="soundToggle"]');
            if (soundEnabled) {
                label.textContent = 'üîä Signalton aktiviert';
                playSound(); // Spiele Ton als Best√§tigung
            } else {
                label.textContent = 'üîá Signalton deaktiviert';
            }
        }

        function scrollToNext() {
            const { currentIndex } = findCurrentAndNext();
            const nextIndex = currentIndex + 1;
            if (nextIndex < schedule.length) {
                document.getElementById(`item-${nextIndex}`).scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('medical');
            const isMedical = document.body.classList.contains('medical');
            localStorage.setItem('theme', isMedical ? 'medical' : 'default');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'medical') {
                document.body.classList.add('medical');
            }
        }

        function loadSoundPreference() {
            const savedSound = localStorage.getItem('soundEnabled');
            if (savedSound !== null) {
                soundEnabled = savedSound === 'true';
                document.getElementById('soundToggle').checked = soundEnabled;
                const label = document.querySelector('label[for="soundToggle"]');
                label.textContent = soundEnabled ? 'üîä Signalton aktiviert' : 'üîá Signalton deaktiviert';
            }
        }

        function init() {
            loadTheme();
            loadSoundPreference();
            updateTime();
            updateTimeline();
            updateNextItem();
            
            if (Notification.permission === 'default') {
                document.getElementById('notificationAlert').classList.add('show');
            }
            
            setInterval(() => {
                updateTime();
                updateTimeline();
                updateNextItem();
                checkForNotifications();
            }, 10000); // Alle 10 Sekunden aktualisieren
        }

        init();
    </script>
</body>
</html>