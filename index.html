<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tagesplan Erinnerungen - 1500 kcal</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 80% 15%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(900px 650px at 50% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(135deg,#0b1220 0%, #101a33 45%, #0b1326 100%);
      min-height:100vh;
      padding:20px;
      color:#eaf0ff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    body.medical{background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);color:#102014}

    .container{
      max-width:820px;margin:0 auto;background:rgba(255,255,255,.95);
      border-radius:22px;box-shadow:0 14px 40px rgba(0,0,0,.28);
      overflow:hidden;border:1px solid rgba(255,255,255,.10);
    }
    body.medical .container{background:#fff;border:0;box-shadow:0 20px 60px rgba(0,0,0,.30)}

    .header{
      background:
        linear-gradient(135deg, rgba(11,18,32,.92) 0%, rgba(16,26,51,.92) 60%, rgba(11,19,38,.92) 100%),
        radial-gradient(900px 260px at 15% 0%, rgba(110,231,255,.25), transparent 60%),
        radial-gradient(900px 260px at 85% 0%, rgba(167,139,250,.22), transparent 60%);
      color:#fff;padding:28px 28px 22px;text-align:center;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    body.medical .header{background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%);border-bottom:0}

    .header h1{font-size:26px;margin-bottom:10px;letter-spacing:.2px}
    .current-time{font-size:46px;font-weight:800;margin:18px 0 12px;text-shadow:2px 2px 8px rgba(0,0,0,.35)}
    .status{font-size:15px;padding:10px 16px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);border-radius:12px;display:inline-block}

    .day-switch{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .day-btn{
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.10);color:#fff;cursor:pointer;font-weight:800;font-size:13px;
      transition:transform .15s ease, background .15s ease;user-select:none
    }
    .day-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.16)}
    .day-btn.active{background:rgba(255,255,255,.28);border-color:rgba(255,255,255,.45)}
    body.medical .day-btn{background:rgba(255,255,255,.70);color:#102014;border:1px solid rgba(16,32,20,.18)}
    body.medical .day-btn.active{background:rgba(255,255,255,.95);border-color:rgba(16,32,20,.25)}

    .sound-toggle{
      display:flex;align-items:center;gap:14px;padding:12px 14px;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16);
      border-radius:12px;margin-top:12px;flex-wrap:wrap;justify-content:center
    }
    .sound-toggle.muted{opacity:0.75}
    .sound-toggle .toggle-row{display:flex;align-items:center;gap:10px}
    .sound-toggle input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
    .sound-toggle .volume-control{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center}
    .sound-toggle .volume-control label{font-weight:700}
    .sound-toggle input[type="range"]{width:180px;accent-color:#0ea5e9;cursor:pointer}
    .sound-toggle .volume-value{font-weight:800;font-variant-numeric:tabular-nums}

    .content{padding:26px;color:#0e172a}
    body.medical .content{color:#0e1b12}

    .notification-permission{
      background:#fff3cd;border:2px solid #ffc107;padding:14px;border-radius:12px;margin-bottom:16px;
      display:none;color:#1f2937
    }
    .notification-permission.show{display:block}

    .panel{
      background:#f3f4f6;border:2px dashed rgba(0,0,0,.14);padding:14px;border-radius:14px;margin-bottom:16px;color:#111827
    }
    .panel h3{margin-bottom:10px;color:#0b1220;font-size:15px}
    body.medical .panel{background:#fff}
    body.medical .panel h3{color:#1b5e20}

    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .row:first-of-type{margin-top:0}
    .row label{font-weight:800;color:#0b1220}
    body.medical .row label{color:#1b5e20}
    .row input[type="time"]{padding:10px 12px;border-radius:12px;border:1px solid #ced4da;font-size:15px;background:#fff}
    .row input[type="checkbox"]{width:18px;height:18px;cursor:pointer}

    .hint{margin-top:10px;font-size:12.5px;color:#374151;line-height:1.45}
    .hint code{background:rgba(0,0,0,.06);padding:2px 6px;border-radius:8px}

    .small-pill{
      display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;
      background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.08);font-weight:800;font-size:13px
    }

    .controls{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .btn{
      padding:12px 18px;border:none;border-radius:12px;font-size:15px;cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;font-weight:800;letter-spacing:.1px
    }
    .btn-primary{background:linear-gradient(135deg,#0ea5e9 0%, #8b5cf6 55%, #22c55e 110%);color:#fff;box-shadow:0 10px 24px rgba(2,6,23,.18)}
    body.medical .btn-primary{background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);box-shadow:none}
    .btn-secondary{background:#eef2f7;color:#0b1220;border:1px solid rgba(15,23,42,.10)}
    .btn-secondary:hover{background:#e6ebf3;transform:translateY(-1px)}

    .next-item{
      background:
        linear-gradient(135deg, rgba(15,23,42,.96) 0%, rgba(30,41,59,.96) 100%),
        radial-gradient(700px 220px at 15% 10%, rgba(110,231,255,.25), transparent 60%),
        radial-gradient(700px 220px at 85% 10%, rgba(167,139,250,.22), transparent 60%);
      color:#fff;padding:22px;border-radius:16px;margin-bottom:16px;box-shadow:0 14px 36px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10)
    }
    body.medical .next-item{background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);box-shadow:0 10px 30px rgba(76,175,80,.3);border:0}
    .next-item h2{font-size:18px;margin-bottom:12px;display:flex;align-items:center;gap:10px;letter-spacing:.2px}
    .next-item h2::before{content:"‚è∞";font-size:22px}
    .next-item .time{font-size:30px;font-weight:800;margin-bottom:8px;letter-spacing:.3px}
    .next-item .description{font-size:15px;line-height:1.6;opacity:.96}

    .timeline{position:relative;padding-left:38px}
    .timeline::before{
      content:"";position:absolute;left:14px;top:0;bottom:0;width:3px;
      background:linear-gradient(180deg, rgba(110,231,255,.85) 0%, rgba(167,139,250,.85) 55%, rgba(34,197,94,.65) 100%);
      border-radius:3px
    }
    body.medical .timeline::before{background:linear-gradient(180deg,#66bb6a 0%,#388e3c 100%)}

    .timeline-item{
      position:relative;padding:14px 14px 12px;margin-bottom:12px;background:#f6f7fb;
      border:1px solid rgba(15,23,42,.08);border-radius:12px;transition:background .2s ease
    }
    .timeline-item::before{
      content:"";position:absolute;left:-31px;top:18px;width:14px;height:14px;border-radius:50%;
      background:#fff;border:3px solid rgba(110,231,255,.9);box-shadow:0 2px 8px rgba(0,0,0,.12)
    }
    body.medical .timeline-item::before{border-color:#4caf50}
    .timeline-item.completed{opacity:.55;background:#eef0f6}
    .timeline-item.completed::before{background:#22c55e;border-color:#22c55e}
    .timeline-item.current{
      background:linear-gradient(135deg,#e8f1ff 0%, #f3e8ff 70%, #e8fff1 100%);
      box-shadow:0 10px 22px rgba(2,6,23,.12);border-color:rgba(110,231,255,.35)
    }
    body.medical .timeline-item.current{
      background:linear-gradient(135deg,#c8e6c9 0%,#a5d6a7 100%);
      box-shadow:0 5px 15px rgba(165,214,167,.4);border-color:transparent
    }
    .timeline-item.current::before{background:rgba(110,231,255,.95);border-color:rgba(110,231,255,.95);animation:pulse 2s infinite}
    body.medical .timeline-item.current::before{background:#2e7d32;border-color:#2e7d32}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
    .timeline-item .time{font-weight:800;color:#0b1220;font-size:16px;margin-bottom:6px}
    body.medical .timeline-item .time{color:#1b5e20}
    .timeline-item .description{color:#111827;font-size:13.5px;line-height:1.5}
    body.medical .timeline-item .description{color:#102014}
    .timeline-item .calories{color:#2563eb;font-weight:800;margin-top:6px;font-size:12.5px}
    body.medical .timeline-item .calories{color:#1b5e20}
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è Dein Tagesplan</h1>
      <div class="current-time" id="currentTime">00:00:00</div>
      <div id="nextItem"></div>
      <div class="status" id="status">L√§dt...</div>

      <div class="day-switch" id="daySwitch">
        <button class="day-btn" data-day="auto">AUTO</button>
        <button class="day-btn" data-day="mon">MO</button>
        <button class="day-btn" data-day="tue">DI</button>
        <button class="day-btn" data-day="wed">MI</button>
        <button class="day-btn" data-day="thu">DO</button>
        <button class="day-btn" data-day="fri">FR</button>
        <button class="day-btn" data-day="sat">SA</button>
        <button class="day-btn" data-day="sun">SO</button>
      </div>

      <div class="sound-toggle" id="soundControls">
        <div class="toggle-row">
          <input type="checkbox" id="soundToggle" checked />
          <label for="soundToggle" style="cursor:pointer;">üîä Signalton aktiviert</label>
        </div>
        <div class="volume-control">
          <label for="volumeSlider" style="cursor:pointer;">üîà Lautst√§rke</label>
          <input type="range" id="volumeSlider" min="0" max="100" value="30" />
          <span class="volume-value" id="volumeValue">30%</span>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="notification-permission" id="notificationAlert">
        <strong>‚ö†Ô∏è Benachrichtigungen aktivieren?</strong><br />
        Damit du rechtzeitig erinnert wirst, erlaube bitte die Browser-Benachrichtigungen.
        <button class="btn btn-primary" id="btnEnableNotifications" style="margin-top:10px;">
          Benachrichtigungen aktivieren
        </button>
      </div>

      <div class="panel">
        <h3>‚è±Ô∏è Verschlafen-Modus (Zeitversatz)</h3>

        <div class="row">
          <label for="anchorTime">Ich bin aufgestanden um</label>
          <input type="time" id="anchorTime" />
          <button class="btn btn-primary" id="btnSetOffset">Offset setzen</button>
          <button class="btn btn-secondary" id="btnResetOffset">Offset zur√ºcksetzen</button>
        </div>

        <div class="row">
          <input type="checkbox" id="applyAllDay" />
          <label for="applyAllDay" style="cursor:pointer;">
            Offset auf <strong>alle</strong> Zeiten anwenden (sonst nur morgens bis 12:00)
          </label>
        </div>

        <div class="row" style="align-items:center;">
          <span class="small-pill" title="Verschiebt Termine ab 12:00 (Mittag + alles danach)">
            üåô Nachmittag (ab 12:00): <span id="afternoonLabel">0 min</span>
          </span>
          <button class="btn btn-primary" id="btnAfternoonMinus">‚àí15</button>
          <button class="btn btn-primary" id="btnAfternoonPlus">+15</button>
          <button class="btn btn-secondary" id="btnAfternoonReset">Reset</button>
        </div>

        <div class="hint">
          <div>‚Ä¢ Standard: Morgen-Offset wirkt nur auf Zeiten <code>vor 12:00</code>.</div>
          <div>‚Ä¢ Haken an: Morgen-Offset wirkt auf <code>alle</code> Zeiten.</div>
          <div>‚Ä¢ Zus√§tzlich kannst du <strong>ab 12:00</strong> alles nach vorn/hinten schieben (‚àí15 / +15).</div>
          <div>‚Ä¢ Speichert automatisch im Browser (localStorage).</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" id="btnTheme">üé® Design wechseln</button>
        <button class="btn btn-primary" id="btnTestNotification">üîî Test-Benachrichtigung</button>
        <button class="btn btn-secondary" id="btnScrollNext">‚¨áÔ∏è Zum n√§chsten Punkt</button>
      </div>

      <h3 style="margin-bottom:18px;color:#111827;">üìã Tages√ºbersicht</h3>
      <div class="timeline" id="timeline"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // 0) Basis / Helpers
    // =========================================================
    function getTimeInMinutes(timeStr){
      const [h,m] = String(timeStr || "0:0").split(":").map(Number);
      return (h*60 + m) || 0;
    }
    function minutesToHHMM(totalMinutes){
      const mod = ((totalMinutes % 1440) + 1440) % 1440;
      const h = String(Math.floor(mod/60)).padStart(2,"0");
      const m = String(mod%60).padStart(2,"0");
      return `${h}:${m}`;
    }
    function getCurrentMinutes(){
      const now = new Date();
      return now.getHours()*60 + now.getMinutes();
    }
    function getCurrentSecondsOfDay(){
      const now = new Date();
      return (now.getHours()*3600) + (now.getMinutes()*60) + now.getSeconds();
    }

    // =========================================================
    // A) Sound (notify.mp3 im ROOT) + leiser + 1 Wiederholung
    // =========================================================
    const NOTIFY_MP3 = "notify.mp3";           // liegt im Repo-Root
    const SOUND_ENABLED_KEY = "soundEnabled";
    const SOUND_VOLUME_KEY = "soundVolume";

    // 1 Wiederholung = spielt insgesamt 2x (einmal + nochmal)
    const REPEAT_COUNT = 1;

    let notifyAudio = null;
    let soundEnabled = true;
    let notifyVolume = 0.30; // Default leiser
    let repeatRemaining = 0;

    function clamp01(v){ return Math.min(1, Math.max(0, v)); }

    function updateSoundControlsState(){
      const container = document.getElementById("soundControls");
      if (container) container.classList.toggle("muted", !soundEnabled);
    }

    function updateVolumeUI(){
      const slider = document.getElementById("volumeSlider");
      const label = document.getElementById("volumeValue");
      const percent = Math.round(notifyVolume * 100);
      if (slider) slider.value = String(percent);
      if (label) label.textContent = `${percent}%`;
    }

    function setVolume(vol, persist){
      notifyVolume = clamp01(vol);
      if (persist) localStorage.setItem(SOUND_VOLUME_KEY, String(notifyVolume));
      if (notifyAudio) notifyAudio.volume = notifyVolume;
      updateVolumeUI();
    }

    function initAudio(){
      if (notifyAudio) return;

      notifyAudio = new Audio(NOTIFY_MP3);
      notifyAudio.preload = "auto";
      notifyAudio.volume = notifyVolume;

      notifyAudio.addEventListener("ended", () => {
        if (repeatRemaining > 0){
          repeatRemaining--;
          notifyAudio.currentTime = 0;
          notifyAudio.play().catch(()=>{});
        }
      });
    }

    // iPad/iOS: Audio muss oft durch User-Geste "freigeschaltet" werden
    function unlockAudioOnce(){
      try{
        initAudio();
        // mini-play/pause (leise) um Audio zu "unlocken"
        const prevVol = notifyAudio.volume;
        notifyAudio.volume = 0.0;
        notifyAudio.play()
          .then(() => { notifyAudio.pause(); notifyAudio.currentTime = 0; notifyAudio.volume = prevVol; })
          .catch(() => { notifyAudio.volume = prevVol; });
      } catch(e){}
      window.removeEventListener("pointerdown", unlockAudioOnce);
      window.removeEventListener("keydown", unlockAudioOnce);
      window.removeEventListener("touchstart", unlockAudioOnce);
    }
    window.addEventListener("pointerdown", unlockAudioOnce, { once:true });
    window.addEventListener("touchstart", unlockAudioOnce, { once:true });
    window.addEventListener("keydown", unlockAudioOnce, { once:true });

    function playSound(){
      if (!soundEnabled) return;
      initAudio();
      repeatRemaining = REPEAT_COUNT;

      try{
        notifyAudio.pause();
        notifyAudio.currentTime = 0;
        notifyAudio.volume = notifyVolume;
        notifyAudio.play().catch(err => console.warn("Audio Play blockiert:", err));
      } catch(e){
        console.warn("Audio-Fehler:", e);
      }
    }

    function toggleSoundUI(){
      const el = document.getElementById("soundToggle");
      soundEnabled = !!(el && el.checked);
      localStorage.setItem(SOUND_ENABLED_KEY, String(soundEnabled));

      const label = document.querySelector('label[for="soundToggle"]');
      if (label){
        label.textContent = soundEnabled ? "üîä Signalton aktiviert" : "üîá Signalton deaktiviert";
      }
      updateSoundControlsState();

      if (soundEnabled) playSound(); // kurzer Best√§tigungston
    }

    // =========================================================
    // B) Pl√§ne laden (plans/mon.js ... plans/sun.js)
    //    Jede Datei: window.schedule = [ ... ];
    // =========================================================
    let schedule = [];

    const DAY_MAP = ["sun","mon","tue","wed","thu","fri","sat"];
    const DAY_OVERRIDE_KEY = "scheduleDayOverride"; // "auto" oder "mon".."sun"
    const MANUAL_UNTIL_KEY = "scheduleManualUntilTs";

    function getTodayKey(){ return DAY_MAP[new Date().getDay()]; }

    function getSelectedDayKey(){
      const params = new URLSearchParams(window.location.search);
      const q = (params.get("day") || "").toLowerCase();
      if (DAY_MAP.includes(q)) return q;

      const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
      if (saved === "auto") return getTodayKey();
      if (DAY_MAP.includes(saved)) return saved;

      return getTodayKey();
    }

    function getPlanFileForDay(dayKey){ return `plans/${dayKey}.js`; }

    function loadScheduleScript(src){
      return new Promise((resolve, reject) => {
        const old = document.getElementById("planScript");
        if (old) old.remove();

        const s = document.createElement("script");
        s.id = "planScript";
        s.src = src + "?v=" + Date.now();
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Konnte Plan-Datei nicht laden: " + src));
        document.head.appendChild(s);
      });
    }

    async function loadPlanForCurrentSelection(){
      const dayKey = getSelectedDayKey();
      await loadScheduleScript(getPlanFileForDay(dayKey));

      if (Array.isArray(window.schedule) && window.schedule.length){
        schedule = window.schedule;
      } else {
        throw new Error("Plan-Datei geladen, aber window.schedule ist leer oder fehlt.");
      }

      setStatusPlanInfo();
      lastAlarmToken = ""; // wichtig: nach Plan-Wechsel neu erlauben
      updateTimeline();
      updateNextItem();
    }

    function setStatusPlanInfo(){
      const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
      const effective = getSelectedDayKey();
      const label = (saved === "auto" ? `AUTO (${effective.toUpperCase()})` : saved.toUpperCase());
      const status = document.getElementById("status");
      if (status) status.textContent = `Plan: ${label}`;
    }

    function showPlanError(e){
      console.error(e);
      const status = document.getElementById("status");
      if (status) status.textContent = "Plan-Datei fehlt/Fehler";

      const nextItemDiv = document.getElementById("nextItem");
      if (nextItemDiv){
        nextItemDiv.innerHTML = `
          <div class="next-item">
            <h2>‚ö†Ô∏è Plan konnte nicht geladen werden</h2>
            <div class="description">${String(e && (e.message || e) || "Unbekannter Fehler")}</div>
          </div>
        `;
      }
      const timeline = document.getElementById("timeline");
      if (timeline) timeline.innerHTML = "";
    }

    // =========================================================
    // C) Offset-Logik
    // =========================================================
    const PLAN_START = "06:15";
    const MORNING_CUTOFF = "12:00";

    const OFFSET_KEY = "scheduleOffsetMin";
    const ANCHOR_KEY = "scheduleAnchorTime";
    const APPLY_ALL_KEY = "scheduleOffsetApplyAllDay";
    const AFTERNOON_KEY = "scheduleAfternoonOffsetMin";

    let offsetMinutes = 0;
    let afternoonOffsetMinutes = 0;
    let applyAllDay = false;

    function getPerItemOffset(item){
      const baseMin = getTimeInMinutes(item.time);
      const cutoffMin = getTimeInMinutes(MORNING_CUTOFF);
      let off = 0;

      if (applyAllDay || baseMin < cutoffMin){
        off += offsetMinutes;
      }
      if (baseMin >= cutoffMin){
        off += afternoonOffsetMinutes;
      }
      return off;
    }

    function getEffectiveItemMinutes(item){
      const perOffset = getPerItemOffset(item);
      return ((getTimeInMinutes(item.time) + perOffset) % 1440 + 1440) % 1440;
    }

    function getEffectiveItemTimeStr(item){
      return minutesToHHMM(getTimeInMinutes(item.time) + getPerItemOffset(item));
    }

    function updateAfternoonLabel(){
      const el = document.getElementById("afternoonLabel");
      if (!el) return;
      const v = afternoonOffsetMinutes || 0;
      el.textContent = (v >= 0 ? `+${v}` : `${v}`) + " min";
    }

    function loadOffset(){
      const saved = localStorage.getItem(OFFSET_KEY);
      offsetMinutes = saved !== null ? (parseInt(saved,10) || 0) : 0;

      const savedAfternoon = localStorage.getItem(AFTERNOON_KEY);
      afternoonOffsetMinutes = savedAfternoon !== null ? (parseInt(savedAfternoon,10) || 0) : 0;

      const anchor = localStorage.getItem(ANCHOR_KEY);
      const anchorInput = document.getElementById("anchorTime");
      if (anchor && anchorInput) anchorInput.value = anchor;

      const savedApplyAll = localStorage.getItem(APPLY_ALL_KEY);
      applyAllDay = savedApplyAll === "true";
      const applyAllEl = document.getElementById("applyAllDay");
      if (applyAllEl) applyAllEl.checked = applyAllDay;

      updateAfternoonLabel();
    }

    function saveOffset(mins, anchorTimeStr){
      offsetMinutes = mins;
      localStorage.setItem(OFFSET_KEY, String(mins));
      if (anchorTimeStr) localStorage.setItem(ANCHOR_KEY, anchorTimeStr);
    }

    function saveAfternoonOffset(mins){
      afternoonOffsetMinutes = mins;
      localStorage.setItem(AFTERNOON_KEY, String(mins));
      updateAfternoonLabel();
    }

    function saveApplyAllDay(v){
      applyAllDay = !!v;
      localStorage.setItem(APPLY_ALL_KEY, applyAllDay ? "true" : "false");
    }

    function applyOffsetFromAnchor(){
      const anchorInput = document.getElementById("anchorTime");
      if (!anchorInput || !anchorInput.value) return;

      const actualStart = getTimeInMinutes(anchorInput.value);
      const planStart = getTimeInMinutes(PLAN_START);
      saveOffset(actualStart - planStart, anchorInput.value);

      lastAlarmToken = "";
      updateTimeline();
      updateNextItem();
    }

    function resetOffset(){
      saveOffset(0, "");
      localStorage.removeItem(ANCHOR_KEY);
      const anchorInput = document.getElementById("anchorTime");
      if (anchorInput) anchorInput.value = "";

      lastAlarmToken = "";
      updateTimeline();
      updateNextItem();
    }

    function shiftAfternoon(delta){
      saveAfternoonOffset((afternoonOffsetMinutes || 0) + delta);
      lastAlarmToken = "";
      updateTimeline();
      updateNextItem();
    }

    function resetAfternoonShift(){
      saveAfternoonOffset(0);
      lastAlarmToken = "";
      updateTimeline();
      updateNextItem();
    }

    // =========================================================
    // D) Anzeige (Timeline / Next)
    // =========================================================
    function updateTime(){
      const now = new Date();
      const el = document.getElementById("currentTime");
      if (el) el.textContent = now.toLocaleTimeString("de-DE");
    }

    function buildSortedByEffectiveTime(){
      const indexed = schedule.map((item, index) => ({
        item, index,
        eff: getEffectiveItemMinutes(item)
      }));
      indexed.sort((a,b) => a.eff - b.eff);
      return indexed;
    }

    function findCurrentAndNext(){
      const currentMinutes = getCurrentMinutes();
      const sorted = buildSortedByEffectiveTime();

      const next = sorted.find(x => x.eff > currentMinutes);
      const nextIndex = next ? next.index : -1;

      let currentSortedPos = -1;
      for (let i=0;i<sorted.length;i++){
        if (sorted[i].eff <= currentMinutes) currentSortedPos = i;
      }
      const currentIndex = currentSortedPos >= 0 ? sorted[currentSortedPos].index : -1;

      return { currentIndex, nextIndex, sorted };
    }

    function updateTimeline(){
      const timeline = document.getElementById("timeline");
      if (!timeline) return;

      if (!Array.isArray(schedule) || !schedule.length){
        timeline.innerHTML = "";
        return;
      }

      const { currentIndex, sorted } = findCurrentAndNext();
      timeline.innerHTML = "";

      sorted.forEach(({ item, index }) => {
        const div = document.createElement("div");
        div.className = "timeline-item";
        div.id = `item-${index}`;

        const currentPos = sorted.findIndex(x => x.index === currentIndex);
        const thisPos = sorted.findIndex(x => x.index === index);

        if (currentIndex !== -1 && thisPos < currentPos) div.classList.add("completed");
        if (index === currentIndex) div.classList.add("current");

        const effTime = getEffectiveItemTimeStr(item);

        div.innerHTML = `
          <div class="time">${effTime} Uhr</div>
          <div class="description">
            <strong>${item.title}</strong>
            ${item.description ? `<br>${item.description}` : ""}
          </div>
          ${item.calories > 0 ? `<div class="calories">üìä ${item.calories} kcal</div>` : ""}
        `;
        timeline.appendChild(div);
      });
    }

    function updateNextItem(){
      const nextItemDiv = document.getElementById("nextItem");
      if (!nextItemDiv) return;

      if (!Array.isArray(schedule) || !schedule.length){
        nextItemDiv.innerHTML = `
          <div class="next-item">
            <h2>‚ö†Ô∏è Kein Plan geladen</h2>
            <div class="description">Bitte pr√ºfe deine Plan-Dateien in <code>plans/</code>.</div>
          </div>
        `;
        return;
      }

      const { nextIndex } = findCurrentAndNext();
      if (nextIndex === -1){
        nextItemDiv.innerHTML = `
          <div class="next-item">
            <h2>‚úÖ Tagesplan abgeschlossen!</h2>
            <div class="description">Alle Punkte f√ºr heute erledigt.</div>
          </div>
        `;
        return;
      }

      const item = schedule[nextIndex];
      const effTime = getEffectiveItemTimeStr(item);

      nextItemDiv.innerHTML = `
        <div class="next-item">
          <h2>Als N√§chstes:</h2>
          <div class="time">${effTime} Uhr</div>
          <div class="description">
            <strong>${item.title}</strong><br>
            ${item.description ? `${item.description}<br>` : ""}
            ${item.calories > 0 ? `<br>üìä ${item.calories} kcal` : ""}
          </div>
        </div>
      `;
    }

    // =========================================================
    // E) Alarm-Trigger (sekundengenau, robust)
    //    -> Sound + optional Notification, 2 Minuten vorher
    // =========================================================
    let lastAlarmToken = "";

    function sendNotification(item){
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;

      const effTime = getEffectiveItemTimeStr(item);
      const n = new Notification("üçΩÔ∏è Tagesplan Erinnerung", {
        body: `${effTime} Uhr: ${item.title}${item.description ? "\n" + item.description : ""}`,
        tag: "meal-reminder",
        requireInteraction: true
      });
      n.onclick = function(){ window.focus(); n.close(); };
    }

    function checkForNotifications(){
      if (!Array.isArray(schedule) || !schedule.length) return;

      const nowSec = getCurrentSecondsOfDay();
      const dayKey = getSelectedDayKey();

      // n√§chstes Ereignis anhand kleinster deltaSec bestimmen
      let best = null;
      for (let i=0;i<schedule.length;i++){
        const item = schedule[i];
        const effMin = getEffectiveItemMinutes(item);
        const effSec = (effMin % 1440) * 60;

        const deltaSec = (effSec - nowSec + 86400) % 86400; // 0..86399
        if (best === null || deltaSec < best.deltaSec){
          best = { index:i, item, effMin, deltaSec };
        }
      }
      if (!best) return;

      // Entprellung: Token f√ºr diesen Termin/Tag
      const token = `${dayKey}|${best.index}|${best.effMin}`;

      // wenn wir weit weg sind, Token freigeben (damit sp√§tere Termine wieder triggern)
      if (best.deltaSec > 300){
        if (lastAlarmToken === token) lastAlarmToken = "";
        return;
      }

      // 2 Minuten vorher ausl√∂sen (tolerant, setInterval alle 10s)
      const LEAD = 120;
      if (best.deltaSec > 0 && best.deltaSec <= LEAD){
        if (lastAlarmToken !== token){
          if (soundEnabled) playSound();
          sendNotification(best.item);
          lastAlarmToken = token;
        }
      }
    }

    function requestNotificationPermission(){
      if (!("Notification" in window)) return;
      Notification.requestPermission().then(permission => {
        if (permission === "granted"){
          const a = document.getElementById("notificationAlert");
          if (a) a.classList.remove("show");
          alert("‚úÖ Benachrichtigungen aktiviert!");
        }
      });
    }

    function testNotification(){
      if (soundEnabled) playSound();
      if (("Notification" in window) && Notification.permission === "granted"){
        new Notification("üçΩÔ∏è Test-Benachrichtigung", { body: "Die Benachrichtigungen funktionieren!" });
      } else if (("Notification" in window) && Notification.permission === "denied"){
        alert("Benachrichtigungen wurden blockiert. Bitte aktiviere sie in den Browser-Einstellungen.");
      } else if ("Notification" in window) {
        requestNotificationPermission();
      }
    }

    function scrollToNext(){
      if (!Array.isArray(schedule) || !schedule.length) return;
      const { nextIndex } = findCurrentAndNext();
      if (nextIndex !== -1){
        const el = document.getElementById(`item-${nextIndex}`);
        if (el) el.scrollIntoView({ behavior:"smooth", block:"center" });
      }
    }

    function toggleTheme(){
      document.body.classList.toggle("medical");
      const isMedical = document.body.classList.contains("medical");
      localStorage.setItem("theme", isMedical ? "medical" : "default");
    }
    function loadTheme(){
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "medical") document.body.classList.add("medical");
    }

    // =========================================================
    // F) Day Switch
    // =========================================================
    function initDaySwitch(){
      const wrap = document.getElementById("daySwitch");
      if (!wrap) return;

      const btns = Array.from(wrap.querySelectorAll(".day-btn"));

      function setActiveButtons(){
        const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
        btns.forEach(b => b.classList.remove("active"));
        const activeKey = saved === "auto" ? "auto" : saved;
        const el = wrap.querySelector(`.day-btn[data-day="${activeKey}"]`);
        if (el) el.classList.add("active");
      }

      btns.forEach(btn => {
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", async () => {
          const key = (btn.getAttribute("data-day") || "auto").toLowerCase();
          if (key === "auto"){
            localStorage.setItem(DAY_OVERRIDE_KEY, "auto");
            localStorage.removeItem(MANUAL_UNTIL_KEY);
          } else {
            localStorage.setItem(DAY_OVERRIDE_KEY, key);
            localStorage.setItem(MANUAL_UNTIL_KEY, String(Date.now() + 60000));
          }
          setActiveButtons();
          try{ await loadPlanForCurrentSelection(); }
          catch(e){ showPlanError(e); }
        });
      });

      setActiveButtons();
    }

    // =========================================================
    // G) Start / Bindings
    // =========================================================
    let isScrolling = false, scrollTimer = null;
    window.addEventListener("scroll", () => {
      isScrolling = true;
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => { isScrolling = false; }, 180);
    }, { passive:true });

    async function start(){
      loadTheme();

      // Sound Prefs laden
      const savedSound = localStorage.getItem(SOUND_ENABLED_KEY);
      if (savedSound !== null) soundEnabled = (savedSound === "true");
      const st = document.getElementById("soundToggle");
      if (st) st.checked = soundEnabled;

      const savedVol = parseFloat(localStorage.getItem(SOUND_VOLUME_KEY));
      if (!Number.isNaN(savedVol)) notifyVolume = clamp01(savedVol);
      setVolume(notifyVolume, false);

      const label = document.querySelector('label[for="soundToggle"]');
      if (label) label.textContent = soundEnabled ? "üîä Signalton aktiviert" : "üîá Signalton deaktiviert";
      updateSoundControlsState();

      loadOffset();
      initDaySwitch();
      updateTime();

      // Bindings
      if (st) st.addEventListener("change", toggleSoundUI);

      const volumeSlider = document.getElementById("volumeSlider");
      if (volumeSlider){
        volumeSlider.addEventListener("input", () => {
          const val = parseInt(volumeSlider.value, 10);
          setVolume(clamp01((Number.isNaN(val) ? 30 : val) / 100), true);
        });
        volumeSlider.addEventListener("change", () => {
          if (soundEnabled) playSound();
        });
      }

      const btnEnable = document.getElementById("btnEnableNotifications");
      if (btnEnable) btnEnable.addEventListener("click", requestNotificationPermission);

      const btnTest = document.getElementById("btnTestNotification");
      if (btnTest) btnTest.addEventListener("click", testNotification);

      const btnScroll = document.getElementById("btnScrollNext");
      if (btnScroll) btnScroll.addEventListener("click", scrollToNext);

      const btnTheme = document.getElementById("btnTheme");
      if (btnTheme) btnTheme.addEventListener("click", toggleTheme);

      const btnSetOffset = document.getElementById("btnSetOffset");
      if (btnSetOffset) btnSetOffset.addEventListener("click", applyOffsetFromAnchor);

      const btnResetOffset = document.getElementById("btnResetOffset");
      if (btnResetOffset) btnResetOffset.addEventListener("click", resetOffset);

      const aAll = document.getElementById("applyAllDay");
      if (aAll) aAll.addEventListener("change", () => {
        saveApplyAllDay(aAll.checked);
        lastAlarmToken = "";
        updateTimeline();
        updateNextItem();
      });

      const bMinus = document.getElementById("btnAfternoonMinus");
      if (bMinus) bMinus.addEventListener("click", () => shiftAfternoon(-15));

      const bPlus = document.getElementById("btnAfternoonPlus");
      if (bPlus) bPlus.addEventListener("click", () => shiftAfternoon(+15));

      const bReset = document.getElementById("btnAfternoonReset");
      if (bReset) bReset.addEventListener("click", resetAfternoonShift);

      if (("Notification" in window) && Notification.permission === "default"){
        const a = document.getElementById("notificationAlert");
        if (a) a.classList.add("show");
      }

      try{ await loadPlanForCurrentSelection(); }
      catch(e){ showPlanError(e); }

      setInterval(async () => {
        updateTime();

        // Auto-Reset (manueller Tag l√§uft nach 1 Minute aus)
        const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
        const until = parseInt(localStorage.getItem(MANUAL_UNTIL_KEY) || "0", 10);
        if (saved !== "auto" && until > 0 && Date.now() >= until){
          localStorage.setItem(DAY_OVERRIDE_KEY, "auto");
          localStorage.removeItem(MANUAL_UNTIL_KEY);
          try{ await loadPlanForCurrentSelection(); }
          catch(e){ showPlanError(e); }
        }

        updateNextItem();
        checkForNotifications();   // ‚úÖ Sound wird hier zuverl√§ssig durch Termin ausgel√∂st
        if (!isScrolling) updateTimeline();
      }, 10000);
    }

    start();
  </script>
</body>
</html>
