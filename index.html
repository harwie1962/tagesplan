<!-- index.html (KitKat-sicher / ES5 / Audio-Unlock / Notification-Fallback / Sound eingebettet) -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tagesplan Erinnerungen - 1500 kcal</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 80% 15%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(900px 650px at 50% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(135deg,#0b1220 0%, #101a33 45%, #0b1326 100%);
      min-height:100vh;
      padding:20px;
      color:#eaf0ff;
      transition:background .5s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body.low-power{
      background:#0b1220;
      transition:none;
    }

    body.medical{
      background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);
      color:#102014;
    }

    .container{
      max-width:820px;
      margin:0 auto;
      background:rgba(255,255,255,.95);
      border-radius:22px;
      box-shadow:0 14px 40px rgba(0,0,0,.28);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    body.low-power .container{
      box-shadow:none;
      border:1px solid rgba(255,255,255,.12);
    }
    body.medical .container{
      background:#fff;
      border:0;
      box-shadow:0 20px 60px rgba(0,0,0,.30);
    }

    .header{
      background:
        linear-gradient(135deg, rgba(11,18,32,.92) 0%, rgba(16,26,51,.92) 60%, rgba(11,19,38,.92) 100%),
        radial-gradient(900px 260px at 15% 0%, rgba(110,231,255,.25), transparent 60%),
        radial-gradient(900px 260px at 85% 0%, rgba(167,139,250,.22), transparent 60%);
      color:#fff;
      padding:28px 28px 22px;
      text-align:center;
      transition:background .5s ease;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    body.low-power .header{
      background:#101a33;
      transition:none;
    }
    body.medical .header{
      background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%);
      border-bottom:0;
    }

    .header h1{
      font-size:26px;
      margin-bottom:10px;
      letter-spacing:.2px;
    }

    .current-time{
      font-size:46px;
      font-weight:800;
      margin:18px 0 12px;
      text-shadow:2px 2px 8px rgba(0,0,0,.35);
    }
    body.low-power .current-time{ text-shadow:none; }

    .status{
      font-size:15px;
      padding:10px 16px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px;
      display:inline-block;
    }

    .day-switch{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .day-btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.10);
      color:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition:transform .15s ease, background .15s ease;
      user-select:none;
    }
    body.low-power .day-btn{ transition:none; }
    .day-btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.16); }
    .day-btn.active{
      background:rgba(255,255,255,.28);
      border-color:rgba(255,255,255,.45);
    }
    body.medical .day-btn{
      background:rgba(255,255,255,.70);
      color:#102014;
      border:1px solid rgba(16,32,20,.18);
    }
    body.medical .day-btn.active{
      background:rgba(255,255,255,.95);
      border-color:rgba(16,32,20,.25);
    }

    .sound-toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      margin-top:12px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .sound-toggle input{ width:20px; height:20px; cursor:pointer; }

    .content{ padding:26px; color:#0e172a; }
    body.medical .content{ color:#0e1b12; }

    .next-item{
      background:
        linear-gradient(135deg, rgba(15,23,42,.96) 0%, rgba(30,41,59,.96) 100%),
        radial-gradient(700px 220px at 15% 10%, rgba(110,231,255,.25), transparent 60%),
        radial-gradient(700px 220px at 85% 10%, rgba(167,139,250,.22), transparent 60%);
      color:#fff;
      padding:22px;
      border-radius:16px;
      margin-bottom:26px;
      box-shadow:0 14px 36px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
    }
    body.low-power .next-item{
      background:#1e293b;
      box-shadow:none;
    }
    body.medical .next-item{
      background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);
      box-shadow:0 10px 30px rgba(76,175,80,.3);
      border:0;
    }

    .next-item h2{ font-size:18px; margin-bottom:12px; display:flex; align-items:center; gap:10px; letter-spacing:.2px; }
    .next-item h2::before{ content:"‚è∞"; font-size:22px; }
    .next-item .time{ font-size:30px; font-weight:800; margin-bottom:8px; letter-spacing:.3px; }
    .next-item .description{ font-size:15px; line-height:1.6; opacity:.96; }

    .timeline{ position:relative; padding-left:38px; }
    .timeline::before{
      content:"";
      position:absolute;
      left:14px;
      top:0;
      bottom:0;
      width:3px;
      background:linear-gradient(180deg, rgba(110,231,255,.85) 0%, rgba(167,139,250,.85) 55%, rgba(34,197,94,.65) 100%);
      border-radius:3px;
    }
    body.low-power .timeline::before{ background:#60a5fa; }
    body.medical .timeline::before{
      background:linear-gradient(180deg,#66bb6a 0%,#388e3c 100%);
    }

    .timeline-item{
      position:relative;
      padding:14px 14px 12px;
      margin-bottom:12px;
      background:#f6f7fb;
      border:1px solid rgba(15,23,42,.08);
      border-radius:12px;
      transition:background .2s ease;
    }
    body.low-power .timeline-item{ transition:none; }
    .timeline-item::before{
      content:"";
      position:absolute;
      left:-31px;
      top:18px;
      width:14px;
      height:14px;
      border-radius:50%;
      background:#fff;
      border:3px solid rgba(110,231,255,.9);
      box-shadow:0 2px 8px rgba(0,0,0,.12);
    }
    body.medical .timeline-item::before{ border-color:#4caf50; }

    .timeline-item.completed{ opacity:.55; background:#eef0f6; }
    .timeline-item.completed::before{ background:#22c55e; border-color:#22c55e; }

    .timeline-item.current{
      background:linear-gradient(135deg,#e8f1ff 0%, #f3e8ff 70%, #e8fff1 100%);
      box-shadow:0 10px 22px rgba(2,6,23,.12);
      border-color:rgba(110,231,255,.35);
    }
    body.low-power .timeline-item.current{
      background:#e2e8f0;
      box-shadow:none;
    }
    body.medical .timeline-item.current{
      background:linear-gradient(135deg,#c8e6c9 0%,#a5d6a7 100%);
      box-shadow:0 5px 15px rgba(165,214,167,.4);
      border-color:transparent;
    }
    .timeline-item.current::before{
      background:rgba(110,231,255,.95);
      border-color:rgba(110,231,255,.95);
      animation:pulse 2s infinite;
    }
    body.low-power .timeline-item.current::before{ animation:none; }
    body.medical .timeline-item.current::before{
      background:#2e7d32;
      border-color:#2e7d32;
    }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }

    .timeline-item .time-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .timeline-item .time{ font-weight:800; color:#0b1220; font-size:16px; }
    body.medical .timeline-item .time{ color:#1b5e20; }
    .timeline-item .scroll-top-btn{
      border:none;
      background:#e2e8f0;
      color:#0b1220;
      font-weight:800;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
      transition:transform .2s ease, background .2s ease;
    }
    .timeline-item .scroll-top-btn:hover{ transform:translateY(-1px); background:#cbd5f5; }
    body.low-power .timeline-item .scroll-top-btn{ transition:none; }
    body.medical .timeline-item .scroll-top-btn{
      background:#e8f5e9;
      color:#1b5e20;
    }
    .timeline-item .description{ color:#111827; font-size:13.5px; line-height:1.5; }
    body.medical .timeline-item .description{ color:#102014; }
    .timeline-item .calories{ color:#2563eb; font-weight:800; margin-top:6px; font-size:12.5px; }
    body.medical .timeline-item .calories{ color:#1b5e20; }
    .timeline-item .acknowledge{
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12.5px;
      color:#111827;
      font-weight:700;
    }
    body.medical .timeline-item .acknowledge{ color:#102014; }
    .timeline-item .acknowledge input{ width:18px; height:18px; cursor:pointer; }
    .timeline-item.acknowledged{
      opacity:.7;
      background:#e9f7ef;
      border-color:rgba(34,197,94,.35);
    }
    body.medical .timeline-item.acknowledged{
      background:#dcedc8;
      border-color:rgba(46,125,50,.35);
    }

    .controls{ display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; }

    .btn{
      padding:12px 18px;
      border:none;
      border-radius:12px;
      font-size:15px;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
      font-weight:800;
      letter-spacing:.1px;
    }
    body.low-power .btn{ transition:none; }
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9 0%, #8b5cf6 55%, #22c55e 110%);
      color:#fff;
      box-shadow:0 10px 24px rgba(2,6,23,.18);
    }
    body.medical .btn-primary{
      background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);
      box-shadow:none;
    }
    .btn-secondary{
      background:#eef2f7;
      color:#0b1220;
      border:1px solid rgba(15,23,42,.10);
    }
    .btn-secondary:hover{ background:#e6ebf3; transform:translateY(-1px); }

    .notification-permission{
      background:#fff3cd;
      border:2px solid #ffc107;
      padding:14px;
      border-radius:12px;
      margin-bottom:16px;
      display:none;
      color:#1f2937;
    }
    .notification-permission.show{ display:block; }

    .panel{
      background:#f3f4f6;
      border:2px dashed rgba(0,0,0,.14);
      padding:14px;
      border-radius:14px;
      margin-bottom:16px;
      color:#111827;
    }
    .panel h3{ margin-bottom:10px; color:#0b1220; font-size:15px; }
    body.medical .panel{ background:#fff; }
    body.medical .panel h3{ color:#1b5e20; }
    .panel-top{
      margin-bottom:16px;
      background:#f8fafc;
      border:1px solid rgba(255,255,255,.25);
      box-shadow:0 10px 28px rgba(2,6,23,.25);
      text-align:left;
    }
    body.low-power .panel-top{ box-shadow:none; }
    body.medical .panel-top{
      background:#fff;
      border:0;
      box-shadow:0 12px 30px rgba(46,125,50,.32);
    }
    .panel-top summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:800;
      color:#0b1220;
      font-size:15px;
      padding:4px 2px;
    }
    body.medical .panel-top summary{ color:#1b5e20; }
    .panel-top summary::-webkit-details-marker{ display:none; }
    .panel-top .chevron{
      font-size:14px;
      opacity:.8;
      transition:transform .2s ease;
    }
    .panel-top[open] .chevron{ transform:rotate(90deg); }
    .panel-top .panel-content{ margin-top:12px; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .row:first-of-type{ margin-top:0; }
    .row label{ font-weight:800; color:#0b1220; }
    body.medical .row label{ color:#1b5e20; }
    .row input[type="time"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #ced4da;
      font-size:15px;
      background:#fff;
    }
    .row input[type="checkbox"]{ width:18px; height:18px; cursor:pointer; }

    .hint{ margin-top:10px; font-size:12.5px; color:#374151; line-height:1.45; }
    .hint code{ background:rgba(0,0,0,.06); padding:2px 6px; border-radius:8px; }

    .small-pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.08);
      font-weight:800;
      font-size:13px;
    }

    .calorie-summary{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:0 0 18px;
    }
    .calorie-pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(135deg,#0ea5e9 0%, #8b5cf6 55%, #22c55e 110%);
      color:#fff;
      font-weight:800;
      box-shadow:0 10px 24px rgba(2,6,23,.18);
    }
    body.low-power .calorie-pill{
      background:#1d4ed8;
      box-shadow:none;
    }
    body.medical .calorie-pill{
      background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);
      box-shadow:none;
    }
    .calorie-label{ opacity:.85; font-weight:700; letter-spacing:.2px; }
    .calorie-value{ font-size:16px; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.82);
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      z-index:9999;
      max-width:92%;
      text-align:center;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <details class="panel panel-top" id="offsetPanel" open>
        <summary>
          <span class="panel-title">‚è±Ô∏è Verschlafen-Modus (Zeitversatz)</span>
          <span class="chevron">‚ñ∂</span>
        </summary>
        <div class="panel-content">
          <div class="row">
            <label for="anchorTime">Ich bin aufgestanden um</label>
            <input type="time" id="anchorTime" placeholder="07:30" />
            <button class="btn btn-primary" onclick="applyOffsetFromAnchor()">Offset setzen</button>
            <button class="btn btn-secondary" onclick="resetOffset()">Offset zur√ºcksetzen</button>
          </div>

          <div class="row">
            <input type="checkbox" id="applyAllDay" onchange="toggleApplyAllDay()" />
            <label for="applyAllDay" style="cursor:pointer;">
              Offset auf <strong>alle</strong> Zeiten anwenden (sonst nur morgens bis 12:00)
            </label>
          </div>

          <div class="row" style="align-items:center;">
            <span class="small-pill" title="Verschiebt Termine AB 12:00 (Mittag + alles danach)">
              üåô Nachmittag (ab 12:00): <span id="afternoonLabel">0 min</span>
            </span>
            <button class="btn btn-primary" onclick="shiftAfternoon(-15)">‚àí15</button>
            <button class="btn btn-primary" onclick="shiftAfternoon(+15)">+15</button>
            <button class="btn btn-secondary" onclick="resetAfternoonShift()">Reset</button>
          </div>

          <div class="hint">
            <div>‚Ä¢ Standard: Morgen-Offset wirkt nur auf Zeiten <code>vor 12:00</code>.</div>
            <div>‚Ä¢ Haken an: Morgen-Offset wirkt auf <code>alle</code> Zeiten.</div>
            <div>‚Ä¢ Zus√§tzlich kannst du <strong>ab 12:00</strong> alles nach vorn/hinten schieben (‚àí15 / +15).</div>
            <div>‚Ä¢ Speichert automatisch im Browser (localStorage).</div>
          </div>
        </div>
      </details>

      <h1>üçΩÔ∏è Dein Tagesplan</h1>
      <div class="current-time" id="currentTime">00:00:00</div>
      <div class="status" id="status">L√§dt...</div>

      <div class="day-switch" id="daySwitch">
        <button class="day-btn" data-day="auto">AUTO</button>
        <button class="day-btn" data-day="mon">MO</button>
        <button class="day-btn" data-day="tue">DI</button>
        <button class="day-btn" data-day="wed">MI</button>
        <button class="day-btn" data-day="thu">DO</button>
        <button class="day-btn" data-day="fri">FR</button>
        <button class="day-btn" data-day="sat">SA</button>
        <button class="day-btn" data-day="sun">SO</button>
      </div>

      <div class="sound-toggle">
        <input type="checkbox" id="soundToggle" checked onchange="toggleSound()" />
        <label for="soundToggle" style="cursor:pointer;">üîä Signalton aktiviert</label>
        <input type="checkbox" id="muteToggle" onchange="toggleMuteForThreeMinutes()" />
        <label for="muteToggle" style="cursor:pointer;">üîá 3 Minuten stumm</label>
      </div>
    </div>

    <div class="content">
      <div class="notification-permission" id="notificationAlert">
        <strong>‚ö†Ô∏è Benachrichtigungen aktivieren?</strong><br />
        Damit du rechtzeitig erinnert wirst, erlaube bitte die Browser-Benachrichtigungen.
        <button class="btn btn-primary" onclick="requestNotificationPermission()" style="margin-top:10px;">
          Benachrichtigungen aktivieren
        </button>
      </div>

      <div class="controls">
        <button class="btn btn-primary" id="audioUnlockBtn" onclick="unlockAudio()">üîì Ton aktivieren</button>
        <button class="btn btn-primary" onclick="toggleTheme()">üé® Design wechseln</button>
        <button class="btn btn-primary" onclick="testNotification()">üîî Test-Benachrichtigung</button>
        <button class="btn btn-secondary" onclick="scrollToNext()">‚¨áÔ∏è Zum n√§chsten Punkt</button>
      </div>

      <div id="nextItem"></div>
      <div class="calorie-summary" id="calorieSummary"></div>

      <h3 style="margin-bottom:18px;color:#111827;">üìã Tages√ºbersicht</h3>
      <div class="timeline" id="timeline"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // Sound Engine (KitKat / ES5 safe) eingebettet
    // ==========================================
    window.Sound = (function () {
      var enabled = true;
      var mutedUntilTs = 0;

      var ctx = null;
      var master = null;
      var unlocked = false;

      function setEnabled(v) { enabled = !!v; }
      function isEnabled() { return enabled; }

      var EVENTS = [
        {"n":"D4","s16":0,"d16":4,"v":0.8},
        {"n":"F#4","s16":4,"d16":4,"v":0.82},
        {"n":"A4","s16":8,"d16":4,"v":0.84},
        {"n":"D5","s16":12,"d16":4,"v":0.86},
        {"n":"C#5","s16":16,"d16":4,"v":0.82},
        {"n":"B4","s16":20,"d16":4,"v":0.8},
        {"n":"A4","s16":24,"d16":4,"v":0.78},
        {"n":"G4","s16":28,"d16":4,"v":0.78}
      ];

      function noteToMidi(n) {
        n = String(n || "C4").replace(/^\s+|\s+$/g, "");
        var m = n.match(/^([A-Ga-g])([#b]?)(-?\d+)$/);
        if (!m) return 60;
        var letter = String(m[1]).toUpperCase();
        var acc = m[2] || "";
        var oct = parseInt(m[3], 10);
        var baseMap = {C:0, D:2, E:4, F:5, G:7, A:9, B:11};
        var sem = baseMap[letter];
        if (acc === "#") sem += 1;
        if (acc === "b") sem -= 1;
        return (oct + 1) * 12 + sem;
      }

      function midiToFreq(m) {
        return 440 * Math.pow(2, (m - 69) / 12);
      }

      function ensureCtx() {
        if (ctx) return true;

        var AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return false;

        try {
          ctx = new AudioCtx();
          master = ctx.createGain();
          master.gain.value = 1.0;
          master.connect(ctx.destination);
          return true;
        } catch (e) {
          ctx = null;
          master = null;
          return false;
        }
      }

      function unlock() {
        if (!ensureCtx()) return false;

        try {
          if (ctx.state === "suspended" && ctx.resume) ctx.resume();

          var o = ctx.createOscillator();
          var g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = 440;
          g.gain.value = 0.0001;
          o.connect(g);
          g.connect(master);

          var t = ctx.currentTime + 0.01;
          o.start(t);
          o.stop(t + 0.02);

          unlocked = true;
          return true;
        } catch (e) {
          return false;
        }
      }

      function isMuted() {
        return Date.now() < mutedUntilTs;
      }

      function muteForMs(ms) {
        mutedUntilTs = Date.now() + Math.max(0, ms || 0);
      }

      function resetMute() {
        mutedUntilTs = 0;
      }

      function calcTotalSteps16() {
        var maxEnd = 0;
        for (var i = 0; i < EVENTS.length; i++) {
          var e = EVENTS[i];
          if (!e) continue;
          var end = (e.s16 || 0) + (e.d16 || 0);
          if (end > maxEnd) maxEnd = end;
        }
        var bars = Math.max(1, Math.ceil(maxEnd / 16));
        return bars * 16;
      }

      function getDurationMs() {
        var BPM = 140;
        var QUARTER = 60 / BPM;
        var SIXTEENTH = QUARTER / 4;
        var total16 = calcTotalSteps16();
        var totalSec = (total16 * SIXTEENTH) + 0.2;
        return Math.round(totalSec * 1000);
      }

      function play() {
        if (!enabled) return;
        if (isMuted()) return;
        if (!ensureCtx()) return;
        if (!unlocked) return;

        try {
          if (ctx.state === "suspended" && ctx.resume) ctx.resume();
        } catch (_) {}

        var BPM = 140;
        var QUARTER = 60 / BPM;
        var SIXTEENTH = QUARTER / 4;

        var VOLUME = 0.45;
        var TYPE = "sine";
        var MAX_VOICES = 3;

        var now = ctx.currentTime + 0.03;

        var sorted = EVENTS.slice().sort(function (a, b) {
          var da = (a && a.s16) || 0;
          var db = (b && b.s16) || 0;
          if (da !== db) return da - db;
          return noteToMidi(a.n) - noteToMidi(b.n);
        });

        var active = [];

        for (var i2 = 0; i2 < sorted.length; i2++) {
          var ev = sorted[i2];
          if (!ev || !ev.n) continue;

          var t0 = now + ((ev.s16 || 0) * SIXTEENTH);
          var dur = Math.max(0.05, ((ev.d16 || 1) * SIXTEENTH));
          var stopAt = t0 + dur;

          for (var k = active.length - 1; k >= 0; k--) {
            if (active[k].stopAt <= t0) active.splice(k, 1);
          }

          if (active.length >= MAX_VOICES) {
            var victim = active.shift();
            try { victim.osc.stop(t0); } catch (_) {}
          }

          var o2 = ctx.createOscillator();
          var g2 = ctx.createGain();

          o2.type = TYPE;
          o2.frequency.value = midiToFreq(noteToMidi(ev.n));

          o2.connect(g2);
          g2.connect(master);

          var vel = (typeof ev.v === "number") ? ev.v : 0.9;
          var v = Math.max(0.0002, VOLUME * vel);

          g2.gain.setValueAtTime(0.0001, t0);
          g2.gain.exponentialRampToValueAtTime(v, t0 + 0.02);
          g2.gain.exponentialRampToValueAtTime(0.0001, t0 + Math.max(0.04, dur - 0.02));

          o2.start(t0);
          o2.stop(stopAt);

          active.push({ osc: o2, stopAt: stopAt });
        }
      }

      return {
        play: play,
        unlock: unlock,
        setEnabled: setEnabled,
        isEnabled: isEnabled,
        muteForMs: muteForMs,
        resetMute: resetMute,
        getDurationMs: getDurationMs
      };
    })();
  </script>

  <script>
    // =========================
    // Storage (sicher)
    // =========================
    function lsGet(k){
      try { return localStorage.getItem(k); } catch(e){ return null; }
    }
    function lsSet(k,v){
      try { localStorage.setItem(k, v); } catch(e){}
    }
    function lsRemove(k){
      try { localStorage.removeItem(k); } catch(e){}
    }

    // =========================
    // Toast (Fallback UI)
    // =========================
    var toastTimer = null;
    function showToast(msg){
      try{
        var old = document.getElementById("toast");
        if (old && old.parentNode) old.parentNode.removeChild(old);

        var d = document.createElement("div");
        d.id = "toast";
        d.className = "toast";
        d.textContent = msg;
        document.body.appendChild(d);

        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function(){
          var t = document.getElementById("toast");
          if (t && t.parentNode) t.parentNode.removeChild(t);
          toastTimer = null;
        }, 2500);
      } catch(e){}
    }

    // =========================
    // Audio Unlock (KitKat)
    // =========================
    var audioUnlocked = false;
    function unlockAudio(){
      audioUnlocked = true;
      try{
        if (window.Sound && typeof window.Sound.unlock === "function"){
          window.Sound.unlock();
        }
      } catch(e){}

      var btn = document.getElementById("audioUnlockBtn");
      if (btn){
        btn.textContent = "‚úÖ Ton aktiv";
        btn.disabled = true;
        btn.style.opacity = "0.7";
      }

      if (soundEnabled && window.Sound && typeof window.Sound.play === "function"){
        try{ window.Sound.play(); } catch(e){}
      }
    }

    // =========================================================
    // 1) Plan-Laden (GitHub Pages): plans/mon.js ... plans/sun.js
    // =========================================================
    var schedule = [];
    var scheduleDirty = true;
    var scheduleVersion = 0;
    var cachedSortedSchedule = [];
    var lastTimelineState = "";

    var DAY_MAP = ["sun","mon","tue","wed","thu","fri","sat"];
    var DAY_OVERRIDE_KEY = "scheduleDayOverride"; // "auto" oder "mon".."sun"
    var MANUAL_UNTIL_KEY = "scheduleManualUntilTs";
    var LOW_POWER_KEY = "scheduleLowPower";

    function detectLowPowerDevice(){
      var mem = navigator.deviceMemory || 0;
      var cores = navigator.hardwareConcurrency || 0;
      return (mem && mem <= 2) || (cores && cores <= 4);
    }

    function detectReducedMotion(){
      try{
        return !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);
      } catch(e){
        return false;
      }
    }

    function applyLowPowerMode(){
      var saved = lsGet(LOW_POWER_KEY);
      var shouldEnable = (saved === null) ? (detectLowPowerDevice() || detectReducedMotion()) : (saved === "true");
      lsSet(LOW_POWER_KEY, shouldEnable ? "true" : "false");
      document.body.classList.toggle("low-power", shouldEnable);
      return shouldEnable;
    }

    function markScheduleDirty(){
      scheduleDirty = true;
      scheduleVersion += 1;
    }

    function applyManualDayTimeout(){
      var saved = (lsGet(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
      var until = parseInt(lsGet(MANUAL_UNTIL_KEY) || "0", 10);
      var expired = (saved !== "auto") && (until <= 0 || Date.now() >= until);

      if (expired){
        lsSet(DAY_OVERRIDE_KEY, "auto");
        lsRemove(MANUAL_UNTIL_KEY);
      }
      return expired;
    }

    function getStoredDayOverride(){
      applyManualDayTimeout();
      return (lsGet(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
    }

    function getTodayKey(){
      return DAY_MAP[new Date().getDay()];
    }

    function getQueryParam(name){
      try{
        var q = window.location.search || "";
        if (!q || q.length < 2) return "";
        q = q.substring(1);
        var parts = q.split("&");
        var i, kv, key, val;
        for (i=0; i<parts.length; i++){
          kv = parts[i].split("=");
          key = decodeURIComponent(kv[0] || "");
          if (key === name){
            val = decodeURIComponent(kv[1] || "");
            return (val || "");
          }
        }
      } catch(e){}
      return "";
    }

    function getSelectedDayKey(){
      var q = (getQueryParam("day") || "").toLowerCase();
      if (DAY_MAP.indexOf(q) !== -1) return q;

      var saved = getStoredDayOverride();
      if (saved === "auto") return getTodayKey();
      if (DAY_MAP.indexOf(saved) !== -1) return saved;

      return getTodayKey();
    }

    function getPlanFileForDay(dayKey){
      return "plans/" + dayKey + ".js";
    }

    function loadScheduleScript(src, cb){
      try{
        var old = document.getElementById("planScript");
        if (old && old.parentNode) old.parentNode.removeChild(old);

        var s = document.createElement("script");
        s.id = "planScript";
        s.src = src + "?v=" + String(Date.now());
        s.onload = function(){ cb(null); };
        s.onerror = function(){ cb(new Error("Konnte Plan-Datei nicht laden: " + src)); };
        document.head.appendChild(s);
      } catch(e){
        cb(e);
      }
    }

    function loadPlanForCurrentSelection(cb){
      var dayKey = getSelectedDayKey();
      var file = getPlanFileForDay(dayKey);

      loadScheduleScript(file, function(err){
        if (err){
          cb(err);
          return;
        }

        if (window.schedule && Object.prototype.toString.call(window.schedule) === "[object Array]" && window.schedule.length){
          schedule = window.schedule;
          markScheduleDirty();
        } else {
          cb(new Error("Plan-Datei geladen, aber window.schedule ist leer oder fehlt."));
          return;
        }

        setStatusPlanInfo();
        loadAcknowledgements();
        stopAlarm();
        updateTimeline(true);
        updateNextItem();
        updateCalorieSummary();
        cb(null);
      });
    }

    function setStatusPlanInfo(){
      var saved = getStoredDayOverride();
      var effective = getSelectedDayKey();
      var label = (saved === "auto") ? ("AUTO (" + effective.toUpperCase() + ")") : saved.toUpperCase();
      var status = document.getElementById("status");
      if (status) status.textContent = "Plan: " + label;
    }

    function syncDayButtonState(){
      var wrap = document.getElementById("daySwitch");
      if (!wrap) return;

      var btns = wrap.querySelectorAll(".day-btn");
      var saved = getStoredDayOverride();
      var i;

      for (i=0; i<btns.length; i++){
        btns[i].classList.remove("active");
      }

      var activeKey = (saved === "auto") ? "auto" : saved;
      var el = wrap.querySelector('.day-btn[data-day="' + activeKey + '"]');
      if (el) el.classList.add("active");
    }

    function initDaySwitch(){
      var wrap = document.getElementById("daySwitch");
      if (!wrap) return;

      var btns = wrap.querySelectorAll(".day-btn");
      var i;

      for (i=0; i<btns.length; i++){
        (function(btn){
          if (btn.getAttribute("data-bound") === "1") return;
          btn.setAttribute("data-bound","1");

          btn.addEventListener("click", function(){
            var key = (btn.getAttribute("data-day") || "auto").toLowerCase();

            if (key === "auto"){
              lsSet(DAY_OVERRIDE_KEY, "auto");
              lsRemove(MANUAL_UNTIL_KEY);
            } else {
              lsSet(DAY_OVERRIDE_KEY, key);
              lsSet(MANUAL_UNTIL_KEY, String(Date.now() + 60000));
            }

            syncDayButtonState();

            loadPlanForCurrentSelection(function(err){
              if (err) showPlanError(err);
            });
          });
        })(btns[i]);
      }

      syncDayButtonState();
    }

    function showPlanError(e){
      try{ console.error(e); } catch(_){}
      var status = document.getElementById("status");
      if (status) status.textContent = "Plan-Datei fehlt/Fehler";

      var nextItemDiv = document.getElementById("nextItem");
      if (nextItemDiv){
        nextItemDiv.innerHTML =
          '<div class="next-item">' +
            '<h2>‚ö†Ô∏è Plan konnte nicht geladen werden</h2>' +
            '<div class="description">' + String((e && (e.message || e)) || "Unbekannter Fehler") + '</div>' +
          '</div>';
      }

      var timeline = document.getElementById("timeline");
      if (timeline) timeline.innerHTML = "";
    }

    // =========================================================
    // 2) Offset-Logik (Morgen-Offset + Nachmittag-Shift ab 12:00)
    // =========================================================
    var PLAN_START = "06:15";
    var MORNING_CUTOFF = "12:00";

    var OFFSET_KEY = "scheduleOffsetMin";
    var ANCHOR_KEY = "scheduleAnchorTime";
    var APPLY_ALL_KEY = "scheduleOffsetApplyAllDay";
    var AFTERNOON_KEY = "scheduleAfternoonOffsetMin";

    var offsetMinutes = 0;
    var afternoonOffsetMinutes = 0;
    var applyAllDay = false;

    var lastNotifiedIndex = -1;
    var soundEnabled = true;
    var muteUiTimerId = null;
    var MUTE_DURATION_MS = 180000;
    var acknowledgedItems = {};
    var activeAlarmIndex = null;
    var alarmTimerId = null;

    function setAck(index, val){
      acknowledgedItems[String(index)] = !!val;
    }
    function hasAck(index){
      return !!acknowledgedItems[String(index)];
    }
    function ackKeysSorted(){
      var keys = [];
      var k;
      for (k in acknowledgedItems){
        if (acknowledgedItems.hasOwnProperty(k) && acknowledgedItems[k]) keys.push(parseInt(k,10));
      }
      keys.sort(function(a,b){ return a-b; });
      return keys;
    }

    function getTimeInMinutes(timeStr){
      var parts = String(timeStr || "00:00").split(":");
      var h = parseInt(parts[0],10) || 0;
      var m = parseInt(parts[1],10) || 0;
      return h*60 + m;
    }

    function minutesToHHMM(totalMinutes){
      var mod = ((totalMinutes % 1440) + 1440) % 1440;
      var h = String(Math.floor(mod/60));
      var m = String(mod%60);
      if (h.length < 2) h = "0" + h;
      if (m.length < 2) m = "0" + m;
      return h + ":" + m;
    }

    function getCurrentMinutes(){
      var now = new Date();
      return now.getHours()*60 + now.getMinutes();
    }

    function getPerItemOffset(item){
      var baseMin = getTimeInMinutes(item.time);
      var cutoffMin = getTimeInMinutes(MORNING_CUTOFF);
      var off = 0;

      if (applyAllDay || baseMin < cutoffMin) off += offsetMinutes;
      if (baseMin >= cutoffMin) off += afternoonOffsetMinutes;

      return off;
    }

    function getEffectiveItemMinutes(item){
      var perOffset = getPerItemOffset(item);
      var v = getTimeInMinutes(item.time) + perOffset;
      return ((v % 1440) + 1440) % 1440;
    }

    function getEffectiveItemTimeStr(item){
      var perOffset = getPerItemOffset(item);
      return minutesToHHMM(getTimeInMinutes(item.time) + perOffset);
    }

    function getAckStorageKey(){
      var dayKey = getSelectedDayKey();
      var dateStr = new Date().toISOString().split("T")[0];
      return "scheduleAck-" + dayKey + "-" + dateStr;
    }

    function loadAcknowledgements(){
      acknowledgedItems = {};
      var key = getAckStorageKey();
      var raw = lsGet(key);
      if (!raw) return;
      try{
        var parsed = JSON.parse(raw);
        if (Object.prototype.toString.call(parsed) === "[object Array]"){
          var i;
          for (i=0; i<parsed.length; i++){
            setAck(Number(parsed[i]), true);
          }
        }
      } catch(e){}
    }

    function saveAcknowledgements(){
      var key = getAckStorageKey();
      var arr = ackKeysSorted();
      lsSet(key, JSON.stringify(arr));
    }

    function setAcknowledged(index, checked){
      setAck(index, checked);
      saveAcknowledgements();

      var el = document.getElementById("item-" + index);
      if (el) el.classList.toggle("acknowledged", checked);

      if (checked && activeAlarmIndex === index){
        stopAlarm();
      }
    }

    function saveOffset(mins, anchorTimeStr){
      offsetMinutes = mins;
      lsSet(OFFSET_KEY, String(mins));
      if (anchorTimeStr) lsSet(ANCHOR_KEY, anchorTimeStr);
      markScheduleDirty();
    }

    function saveAfternoonOffset(mins){
      afternoonOffsetMinutes = mins;
      lsSet(AFTERNOON_KEY, String(mins));
      updateAfternoonLabel();
      markScheduleDirty();
    }

    function updateAfternoonLabel(){
      var el = document.getElementById("afternoonLabel");
      if (!el) return;
      var v = afternoonOffsetMinutes || 0;
      el.textContent = (v >= 0 ? ("+" + v) : String(v)) + " min";
    }

    function saveApplyAllDay(value){
      applyAllDay = !!value;
      lsSet(APPLY_ALL_KEY, applyAllDay ? "true" : "false");
      markScheduleDirty();
    }

    function loadOffset(){
      var saved = lsGet(OFFSET_KEY);
      offsetMinutes = (saved !== null) ? (parseInt(saved,10) || 0) : 0;

      var savedAfternoon = lsGet(AFTERNOON_KEY);
      afternoonOffsetMinutes = (savedAfternoon !== null) ? (parseInt(savedAfternoon,10) || 0) : 0;

      var anchor = lsGet(ANCHOR_KEY);
      var anchorInput = document.getElementById("anchorTime");
      if (anchor && anchorInput) anchorInput.value = anchor;

      var savedApplyAll = lsGet(APPLY_ALL_KEY);
      applyAllDay = (savedApplyAll === "true");
      var applyAllEl = document.getElementById("applyAllDay");
      if (applyAllEl) applyAllEl.checked = applyAllDay;

      updateAfternoonLabel();
    }

    function toggleApplyAllDay(){
      var el = document.getElementById("applyAllDay");
      saveApplyAllDay(el && el.checked);
      lastNotifiedIndex = -1;
      updateTimeline(true);
      updateNextItem();
      updateCalorieSummary();
    }

    function applyOffsetFromAnchor(){
      var anchorInput = document.getElementById("anchorTime");
      if (!anchorInput || !anchorInput.value) return;

      var actualStart = getTimeInMinutes(anchorInput.value);
      var planStart = getTimeInMinutes(PLAN_START);

      var mins = actualStart - planStart;
      saveOffset(mins, anchorInput.value);

      lastNotifiedIndex = -1;
      updateTimeline(true);
      updateNextItem();
      updateCalorieSummary();
    }

    function resetOffset(){
      saveOffset(0, "");
      lsRemove(ANCHOR_KEY);

      var anchorInput = document.getElementById("anchorTime");
      if (anchorInput) anchorInput.value("");

      lastNotifiedIndex = -1;
      updateTimeline(true);
      updateNextItem();
      updateCalorieSummary();
    }

    function shiftAfternoon(delta){
      saveAfternoonOffset((afternoonOffsetMinutes || 0) + delta);
      lastNotifiedIndex = -1;
      updateTimeline(true);
      updateNextItem();
      updateCalorieSummary();
    }

    function resetAfternoonShift(){
      saveAfternoonOffset(0);
      lastNotifiedIndex = -1;
      updateTimeline(true);
      updateNextItem();
      updateCalorieSummary();
    }

    // =========================================================
    // 3) Anzeige-Logik (Timeline / Next)
    // =========================================================
    function updateTime(){
      var now = new Date();
      var el = document.getElementById("currentTime");
      if (el) el.textContent = now.toLocaleTimeString("de-DE");
    }

    function getSortedSchedule(){
      if (!schedule || !schedule.length) return [];
      if (!scheduleDirty && cachedSortedSchedule.length){
        return cachedSortedSchedule;
      }

      var mapped = [];
      var i;
      for (i=0; i<schedule.length; i++){
        mapped.push({ item: schedule[i], index: i, eff: getEffectiveItemMinutes(schedule[i]) });
      }
      mapped.sort(function(a,b){ return a.eff - b.eff; });

      cachedSortedSchedule = mapped;
      scheduleDirty = false;
      return cachedSortedSchedule;
    }

    function findCurrentAndNext(){
      var currentMinutes = getCurrentMinutes();
      var sorted = getSortedSchedule();

      var nextIndex = -1;
      var currentIndex = -1;

      var i, entry;
      for (i=0; i<sorted.length; i++){
        entry = sorted[i];
        if (entry.eff <= currentMinutes){
          currentIndex = entry.index;
        } else {
          if (nextIndex === -1) nextIndex = entry.index;
          break;
        }
      }

      return { currentIndex: currentIndex, nextIndex: nextIndex, sorted: sorted };
    }

    function updateTimeline(force){
      var timeline = document.getElementById("timeline");
      if (!timeline) return;

      if (!schedule || !schedule.length){
        timeline.innerHTML = "";
        return;
      }

      var info = findCurrentAndNext();
      var currentIndex = info.currentIndex;
      var sorted = info.sorted;

      var ackKey = ackKeysSorted().join(",");
      var stateKey = String(scheduleVersion) + "|" + String(currentIndex) + "|" + ackKey;
      if (!force && stateKey === lastTimelineState) return;
      lastTimelineState = stateKey;

      timeline.innerHTML = "";

      var positions = {};
      var i;
      for (i=0; i<sorted.length; i++){
        positions[String(sorted[i].index)] = i;
      }
      var currentPos = positions[String(currentIndex)];

      for (i=0; i<sorted.length; i++){
        (function(entry){
          var item = entry.item;
          var index = entry.index;

          var div = document.createElement("div");
          div.className = "timeline-item";
          div.id = "item-" + index;

          var thisPos = positions[String(index)];

          if (currentIndex !== -1 && thisPos < currentPos) div.classList.add("completed");
          if (index === currentIndex) div.classList.add("current");

          var effTime = getEffectiveItemTimeStr(item);

          var isAcknowledged = hasAck(index);
          if (isAcknowledged) div.classList.add("acknowledged");

          var descExtra = "";
          if (item.description){
            descExtra = "<br>" + item.description;
          }
          var kcal = "";
          if (parseInt(item.calories,10) > 0){
            kcal = '<div class="calories">üìä ' + parseInt(item.calories,10) + ' kcal</div>';
          }

          div.innerHTML =
            '<div class="time-row">' +
              '<div class="time">' + effTime + ' Uhr</div>' +
              '<button type="button" class="scroll-top-btn" aria-label="Nach oben">‚¨Ü Nach oben</button>' +
            '</div>' +
            '<div class="description">' +
              '<strong>' + item.title + '</strong>' +
              descExtra +
            '</div>' +
            kcal +
            '<label class="acknowledge">' +
              '<input type="checkbox" class="ack-checkbox" data-index="' + index + '"' + (isAcknowledged ? ' checked' : '') + ' />' +
              'Erledigt' +
            '</label>';

          var checkbox = div.querySelector(".ack-checkbox");
          if (checkbox){
            checkbox.addEventListener("change", function(){
              setAcknowledged(index, checkbox.checked);
            });
          }
          var topBtn = div.querySelector(".scroll-top-btn");
          if (topBtn){
            topBtn.addEventListener("click", function(){
              scrollToTop();
            });
          }
          timeline.appendChild(div);
        })(sorted[i]);
      }
    }

    function scrollToTop(){
      try{
        if ("scrollBehavior" in document.documentElement.style){
          window.scrollTo({ top: 0, behavior: "smooth" });
          return;
        }
      } catch (_) {}
      window.scrollTo(0, 0);
    }

    function updateNextItem(){
      var nextItemDiv = document.getElementById("nextItem");
      if (!nextItemDiv) return;

      if (!schedule || !schedule.length){
        nextItemDiv.innerHTML =
          '<div class="next-item">' +
            '<h2>‚ö†Ô∏è Kein Plan geladen</h2>' +
            '<div class="description">Bitte pr√ºfe deine Plan-Dateien in <code>plans/</code>.</div>' +
          '</div>';
        return;
      }

      var info = findCurrentAndNext();
      var nextIndex = info.nextIndex;

      if (nextIndex === -1){
        nextItemDiv.innerHTML =
          '<div class="next-item">' +
            '<h2>‚úÖ Tagesplan abgeschlossen!</h2>' +
            '<div class="description">Alle Punkte f√ºr heute erledigt.</div>' +
          '</div>';
        return;
      }

      var nextItem = schedule[nextIndex];
      var currentMinutes = getCurrentMinutes();
      var nextMinutes = getEffectiveItemMinutes(nextItem);

      var minutesUntil = nextMinutes - currentMinutes;
      if (minutesUntil < 0) minutesUntil += 1440;

      var effTime = getEffectiveItemTimeStr(nextItem);

      var desc = "";
      if (nextItem.description) desc += nextItem.description + "<br>";
      if (parseInt(nextItem.calories,10) > 0) desc += "<br>üìä " + parseInt(nextItem.calories,10) + " kcal";

      nextItemDiv.innerHTML =
        '<div class="next-item">' +
          '<h2>Als N√§chstes:</h2>' +
          '<div class="time">' + effTime + ' Uhr</div>' +
          '<div class="description">' +
            '<strong>' + nextItem.title + '</strong><br>' +
            desc +
          '</div>' +
        '</div>';
    }

    function calculateCalorieTotals(){
      if (!schedule || !schedule.length) return null;

      var total = 0;
      var i;
      for (i=0; i<schedule.length; i++){
        total += (parseInt(schedule[i].calories, 10) || 0);
      }

      var currentMinutes = getCurrentMinutes();

      var sorted = [];
      for (i=0; i<schedule.length; i++){
        sorted.push({ item: schedule[i], eff: getEffectiveItemMinutes(schedule[i]) });
      }
      sorted.sort(function(a,b){ return a.eff - b.eff; });

      var completed = 0;
      for (i=0; i<sorted.length; i++){
        var kcal = parseInt(sorted[i].item.calories, 10) || 0;
        if (sorted[i].eff <= currentMinutes) completed += kcal;
      }

      var remaining = Math.max(total - completed, 0);
      return { total: total, completed: completed, remaining: remaining };
    }

    function updateCalorieSummary(){
      var summary = document.getElementById("calorieSummary");
      if (!summary) return;

      if (!schedule || !schedule.length){
        summary.innerHTML = "";
        return;
      }

      var totals = calculateCalorieTotals();
      if (!totals){
        summary.innerHTML = "";
        return;
      }

      summary.innerHTML =
        '<div class="calorie-pill">' +
          '<span class="calorie-label">Gesamt</span>' +
          '<span class="calorie-value">' + totals.total + ' kcal</span>' +
        '</div>' +
        '<div class="calorie-pill">' +
          '<span class="calorie-label">Erledigt</span>' +
          '<span class="calorie-value">' + totals.completed + ' kcal</span>' +
        '</div>' +
        '<div class="calorie-pill">' +
          '<span class="calorie-label">Offen</span>' +
          '<span class="calorie-value">' + totals.remaining + ' kcal</span>' +
        '</div>';
    }

    // =========================================================
    // 4) Notifications / Sound / Theme / Scroll
    // =========================================================
    function notificationsSupported(){
      return ("Notification" in window);
    }

    function checkForNotifications(){
      if (!notificationsSupported()) return;
      if (Notification.permission !== "granted") return;
      if (!schedule || !schedule.length) return;

      var info = findCurrentAndNext();
      var nextIndex = info.nextIndex;
      if (nextIndex === -1 || nextIndex === lastNotifiedIndex) return;

      var nextItem = schedule[nextIndex];
      var currentMinutes = getCurrentMinutes();
      var nextMinutes = getEffectiveItemMinutes(nextItem);

      var minutesUntil = nextMinutes - currentMinutes;
      if (minutesUntil < -720) minutesUntil += 1440;
      if (minutesUntil < 0) minutesUntil += 1440;

      if (minutesUntil <= 2){
        sendNotification(nextItem);
        lastNotifiedIndex = nextIndex;
      }
    }

    function sendNotification(item){
      var effTime = getEffectiveItemTimeStr(item);

      if (audioUnlocked && soundEnabled && window.Sound && typeof window.Sound.play === "function"){
        try{ window.Sound.play(); } catch(e){}
      }

      if (!notificationsSupported() || Notification.permission !== "granted"){
        showToast(effTime + " Uhr: " + item.title);
        return;
      }

      try{
        var body = effTime + " Uhr: " + item.title + (item.description ? ("\n" + item.description) : "");
        var n = new Notification("üçΩÔ∏è Tagesplan Erinnerung", {
          body: body,
          tag: "meal-reminder",
          requireInteraction: true
        });

        n.onclick = function(){
          try{ window.focus(); } catch(e){}
          try{ n.close(); } catch(e){}
        };
      } catch(e){
        showToast(effTime + " Uhr: " + item.title);
      }
    }

    function requestNotificationPermission(){
      if (!notificationsSupported()){
        showToast("Benachrichtigungen werden auf diesem Ger√§t/Browser nicht unterst√ºtzt.");
        return;
      }

      try{
        Notification.requestPermission(function(permission){
          if (permission === "granted"){
            var a = document.getElementById("notificationAlert");
            if (a) a.classList.remove("show");
            alert("‚úÖ Benachrichtigungen aktiviert!");
          } else {
            showToast("Benachrichtigungen nicht erlaubt.");
          }
        });
      } catch(e){
        showToast("Benachrichtigungen nicht verf√ºgbar.");
      }
    }

    function testNotification(){
      if (!notificationsSupported()){
        showToast("Benachrichtigungen nicht unterst√ºtzt (KitKat).");
        if (audioUnlocked && soundEnabled && window.Sound && typeof window.Sound.play === "function"){
          try{ window.Sound.play(); } catch(e){}
        }
        return;
      }

      if (Notification.permission === "granted"){
        if (audioUnlocked && soundEnabled && window.Sound && typeof window.Sound.play === "function"){
          try{
            window.Sound.play();
            var repeatDelay = (window.Sound && typeof window.Sound.getDurationMs === "function")
              ? window.Sound.getDurationMs()
              : 0;
            if (repeatDelay > 0){
              setTimeout(function(){
                if (audioUnlocked && soundEnabled && window.Sound && typeof window.Sound.play === "function"){
                  try{ window.Sound.play(); } catch(e){}
                }
              }, repeatDelay);
            }
          } catch(e){}
        }
        try{
          new Notification("üçΩÔ∏è Test-Benachrichtigung", { body: "Die Benachrichtigungen funktionieren!" });
        } catch(e){
          showToast("Benachrichtigung konnte nicht angezeigt werden.");
        }
      } else if (Notification.permission === "denied"){
        alert("Benachrichtigungen wurden blockiert. Bitte aktiviere sie in den Browser-Einstellungen.");
      } else {
        requestNotificationPermission();
      }
    }

    function toggleSound(){
      var el = document.getElementById("soundToggle");
      soundEnabled = !!(el && el.checked);
      lsSet("soundEnabled", String(soundEnabled));

      if (window.Sound && typeof window.Sound.setEnabled === "function"){
        try{ window.Sound.setEnabled(soundEnabled); } catch(e){}
      }

      if (!soundEnabled) stopAlarm();

      var label = document.querySelector('label[for="soundToggle"]');
      if (!label) return;

      if (soundEnabled){
        label.textContent = "üîä Signalton aktiviert";
        if (audioUnlocked && window.Sound && typeof window.Sound.play === "function"){
          try{ window.Sound.play(); } catch(e){}
        }
      } else {
        label.textContent = "üîá Signalton deaktiviert";
      }
    }

    function updateMuteToggleLabel(isMuted){
      var label = document.querySelector('label[for="muteToggle"]');
      if (!label) return;
      label.textContent = isMuted ? "üîá 3 Minuten stumm (aktiv)" : "üîá 3 Minuten stumm";
    }

    function toggleMuteForThreeMinutes(){
      var el = document.getElementById("muteToggle");
      var isMuted = !!(el && el.checked);

      if (muteUiTimerId) clearTimeout(muteUiTimerId);

      if (isMuted){
        if (window.Sound && typeof window.Sound.muteForMs === "function"){
          try{ window.Sound.muteForMs(MUTE_DURATION_MS); } catch(e){}
        }
        updateMuteToggleLabel(true);
        muteUiTimerId = setTimeout(function(){
          var toggle = document.getElementById("muteToggle");
          if (toggle) toggle.checked = false;
          updateMuteToggleLabel(false);
          muteUiTimerId = null;
        }, MUTE_DURATION_MS);
      } else {
        if (window.Sound && typeof window.Sound.resetMute === "function"){
          try{ window.Sound.resetMute(); } catch(e){}
        }
        updateMuteToggleLabel(false);
      }
    }

    function scrollToNext(){
      if (!schedule || !schedule.length) return;
      var info = findCurrentAndNext();
      var nextIndex = info.nextIndex;
      if (nextIndex !== -1){
        var el = document.getElementById("item-" + nextIndex);
        if (el && el.scrollIntoView){
          try{ el.scrollIntoView({ behavior:"smooth", block:"center" }); }
          catch(e){ el.scrollIntoView(true); }
        }
      }
    }

    function toggleTheme(){
      document.body.classList.toggle("medical");
      var isMedical = document.body.classList.contains("medical");
      lsSet("theme", isMedical ? "medical" : "default");
    }

    function loadTheme(){
      var savedTheme = lsGet("theme");
      if (savedTheme === "medical") document.body.classList.add("medical");
    }

    function loadSoundPreference(){
      var savedSound = lsGet("soundEnabled");
      if (savedSound !== null){
        soundEnabled = (savedSound === "true");
        var t = document.getElementById("soundToggle");
        if (t) t.checked = soundEnabled;

        if (window.Sound && typeof window.Sound.setEnabled === "function"){
          try{ window.Sound.setEnabled(soundEnabled); } catch(e){}
        }

        var label = document.querySelector('label[for="soundToggle"]');
        if (label) label.textContent = soundEnabled ? "üîä Signalton aktiviert" : "üîá Signalton deaktiviert";
      } else {
        if (window.Sound && typeof window.Sound.setEnabled === "function"){
          try{ window.Sound.setEnabled(true); } catch(e){}
        }
      }
    }

    function initMuteToggle(){
      var t = document.getElementById("muteToggle");
      if (t) t.checked = false;
      updateMuteToggleLabel(false);
    }

    function startAlarmForIndex(index){
      if (!soundEnabled || !window.Sound) return;
      if (!audioUnlocked) return;
      if (activeAlarmIndex === index && alarmTimerId) return;

      stopAlarm();
      activeAlarmIndex = index;

      try{
        if (window.Sound && typeof window.Sound.play === "function") window.Sound.play();
      } catch(e){}

      alarmTimerId = setInterval(function(){
        if (!soundEnabled || !audioUnlocked || !window.Sound) return;
        try{
          if (window.Sound && typeof window.Sound.play === "function") window.Sound.play();
        } catch(e){}
      }, 30000);
    }

    function stopAlarm(){
      if (alarmTimerId){
        clearInterval(alarmTimerId);
        alarmTimerId = null;
      }
      activeAlarmIndex = null;
    }

    function checkForRepeatingAlarm(){
      if (!schedule || !schedule.length) return;
      if (!soundEnabled) return;
      if (!audioUnlocked) return;

      if (activeAlarmIndex !== null){
        if (hasAck(activeAlarmIndex)) stopAlarm();
        return;
      }

      var currentMinutes = getCurrentMinutes();
      var sorted = getSortedSchedule();

      var candidate = null;
      var i;
      for (i=0; i<sorted.length; i++){
        var entry = sorted[i];
        var minutesUntil = entry.eff - currentMinutes;
        if (minutesUntil < -720) minutesUntil += 1440;
        if (minutesUntil < 0) minutesUntil += 1440;
        if (minutesUntil <= 2){
          candidate = entry;
          break;
        }
      }

      if (candidate && !hasAck(candidate.index)){
        startAlarmForIndex(candidate.index);
      }
    }

    // Scroll-Detektor
    var isScrolling = false;
    var scrollTimer = null;
    window.addEventListener("scroll", function(){
      isScrolling = true;
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(function(){ isScrolling = false; }, 180);
    }, false);

    // =========================================================
    // 5) Start
    // =========================================================
    function start(){
      var lowPowerEnabled = applyLowPowerMode();
      loadTheme();
      loadSoundPreference();
      initMuteToggle();
      loadOffset();
      initDaySwitch();

      var resetOnLoad = applyManualDayTimeout();
      if (resetOnLoad) syncDayButtonState();

      updateTime();
      updateCalorieSummary();

      if (notificationsSupported()){
        try{
          if (Notification.permission === "default"){
            var a = document.getElementById("notificationAlert");
            if (a) a.classList.add("show");
          }
        } catch(e){}
      }

      loadPlanForCurrentSelection(function(err){
        if (err) showPlanError(err);
      });

      var updateIntervalMs = lowPowerEnabled ? 20000 : 10000;

      setInterval(function(){
        updateTime();

        var wasResetToAuto = applyManualDayTimeout();

        if (wasResetToAuto) {
          syncDayButtonState();
          loadPlanForCurrentSelection(function(err){
            if (err) showPlanError(err);
            setStatusPlanInfo();
          });
        }

        updateNextItem();
        updateCalorieSummary();
        checkForNotifications();
        checkForRepeatingAlarm();
        if (!isScrolling) updateTimeline(false);
      }, updateIntervalMs);
    }

    start();
  </script>
</body>
</html>
